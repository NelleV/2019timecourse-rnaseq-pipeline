
title: "Shoemaker et al, 2015: An Ultrasensitive Mechanism Regulates Influenza Virus-Induced Inflammation"
output: rmarkdown::html_vignette

---



```{r echo=TRUE, results="hide"}
# Loading dependencies
library(devtools)
library(limma)
library(splines)
library(stats)
library(moanin)

# library(moanin)
```

```{r echo=TRUE}
# Set options
df = 6

# Preprocessing & filtering
is_count = FALSE
take_log = FALSE    
filter_expression = FALSE

# Differential expression analysis
timecourse_contrasts = c("C-K", "C-M")

# Clustering
filter_genes = TRUE
n_genes_to_keep = 5000
n_clusters = 20
percentage_genes_to_label = 0.5
```

```{r echo=FALSE}
# Set data files and options
data("shoemaker2015")
data = shoemaker2015$data
meta = shoemaker2015$meta

# Right now, the package doesn't contain the normalized data
```


# Normalization

FIXME this is not the normalization to use (this is the one for the EPICON
data)

```{r normalization}
if(is_count){
    # Normalize
    data_set = EDASeq::newSeqExpressionSet(as.matrix(data), phenoData=meta)
    data_normalized = EDASeq::betweenLaneNormalization(
	data_set, which="upper", offset=TRUE, round=FALSE)
    data_normalized = EDASeq::normCounts(data_normalized)
}
```

# Differential expression analysis


## Time-course differential expression analysis between two groups

FIXME add estimation of log fold change.

```{r de_analysis}
# Define contrast
de_analysis = data.frame(row.names=row.names(data))
for(contrast_formula in timecourse_contrasts){
    contrast = limma::makeContrasts(
	contrast_formula,
	levels=levels(meta$Group))
    model = moanin:::edgeWithContrasts(as.matrix(data), meta, contrast)
    contrast_name = gsub(" ", "", contrast_formula, fixed=TRUE)
    contrast_name_pval = paste(contrast_name, "-pval", sep="")
    contrast_name_qval = paste(contrast_name, "-qval", sep="")
    de_analysis[contrast_name_pval] = model$pval_lrt
    de_analysis[contrast_name_qval] = model$qval_lrt
}

pvalues = de_analysis
```


## Developmental differential expression analysis

```{r}
# Define contrast
contrast_formula = "C"
contrast = limma::makeContrasts(
    contrast_formula,
    levels=levels(meta$Group))
# Why do I have to do this again?
mask = with(meta, Group == contrast_formula)
model = moanin:::edgeWithContrasts(
    as.matrix(data), meta, contrast, developmental=TRUE,
    mask=mask)
```

## Weekly differential expression analysis

```{r}
# Define contrast
contrasts = c("C.0-K.0",
	      "C.3-K.3",
	      "C.6-K.6",
	      "C.9-K.9",
	      "C.12-K.12",
	      "C.18-K.18",
	      "C.24-K.24",
	      "C.30-K.30",
	      "C.48-K.48",
	      "C.60-K.60",
	      "C.120-K.120",
	      "C.168-K.168")
	
meta$WeeklyGroup = make.names(meta$Group:as.factor(meta$Time))
# de_analysis =  fit_weekly_analysis(
#     data, meta, contrasts,
#     use_voom_weights=FALSE)
```

# Clustering

```{r}
if(filter_genes){
    # Filter out q-values for the pvalues table
    col_to_keep = colnames(pvalues)[grepl("-pval", colnames(pvalues))]
    pvalues = pvalues[, col_to_keep]
    fishers_pval = moanin:::fisher_method(pvalues)
    genes_to_keep = names(sort(fishers_pval)[1:n_genes_to_keep])
    y = as.matrix(data[genes_to_keep, ])
}else{
    y = as.matrix(data)
}

###############################################################################
# Fit the splines


kmeans_clusters = moanin::splines_kmeans(
    y, meta, n_clusters=20,
    random_seed=42,
    degrees_of_freedom=df)

# Rescale the centroids
centroids = moanin::rescale_values(kmeans_clusters$centroids, meta)
all_scores = data.frame(row.names=row.names(data))
for(k in 1:n_clusters){
    scores = moanin:::score_genes_centroid(data, centroids[k,])
    all_scores[paste0("cluster_", k)] = scores
}

# Only assign labels to X% of the genes
max_score = quantile(moanin:::row_min(all_scores), c(percentage_genes_to_label))
genes_to_not_consider = moanin:::row_min(all_scores) >= max_score
labels = moanin:::row_argmin(all_scores)
labels[genes_to_not_consider] = NA
```

```{r}
print(unique(labels))
```


```{r}
moanin::plot_centroids(centroids, meta)
```

# Downstream analysis


```{r}

```
