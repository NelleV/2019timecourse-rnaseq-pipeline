---
title: "Shoemaker et al, 2015: An Ultrasensitive Mechanism Regulates Influenza Virus-Induced Inflammation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::knitr}
    %\VignetteIndexEntry{Title of your vignette}
      %\usepackage[UTF-8]{inputenc}
---

```{r}
# Loading dependencies
library(devtools)
library(limma)
library(splines)
library(stats)

# library(moanin)
load_all("../bin/moanin")
```

```{r}
# Set options
df = 6

# Preprocessing & filtering
take_log = FALSE    
filter_expression = FALSE

# Differential expression analysis
timecourse_contrasts = c("C-K", "C-M")

# Clustering
filter_genes = TRUE
n_genes_to_keep = 5000
n_clusters = 20
percentage_genes_to_label = 0.5
```

```{r}
# Set data files and options
data("shoemaker2015")
data = shoemaker2015$data
meta = shoemaker2015$meta
```


# Normalization

FIXME this is not the normalization to use (this is the one for the EPICON
data)
```{r}
# Normalize
data_set = EDASeq::newSeqExpressionSet(as.matrix(data), phenoData=meta)
data_normalized = EDASeq::betweenLaneNormalization(
    data_set, which="upper", offset=TRUE, round=FALSE)
data_normalized = EDASeq::normCounts(data_normalized)
```


# Differential expression analysis


## Time-course differential expression analysis between two groups

FIXME add estimation of log fold change.

```{r}
# Define contrast
de_analysis = data.frame(row.names=row.names(data))
for(contrast_formula in timecourse_contrasts){
    contrast = limma::makeContrasts(
	contrast_formula,
	levels=levels(meta$Group))
    model = edgeWithContrasts(as.matrix(data), meta, contrast)
    contrast_name = gsub(" ", "", contrast_formula, fixed=TRUE)
    contrast_name_pval = paste(contrast_name, "-pval", sep="")
    contrast_name_qval = paste(contrast_name, "-qval", sep="")
    de_analysis[contrast_name_pval] = model$pval
    de_analysis[contrast_name_qval] = model$qval
}

pvalues = de_analysis
```


## Developmental differential expression analysis

```{r}
# Define contrast
contrast_formula = "C"
contrast = limma::makeContrasts(
    contrast_formula,
    levels=levels(meta$Group))
# Why do I have to do this again?
mask = with(meta, Group == contrast_formula)
model = edgeWithContrasts(
    as.matrix(data), meta, contrast, developmental=TRUE,
    mask=mask)
```

## Weekly differential expression analysis

```{r}
# Define contrast
contrasts = c("C.0-K.0",
	      "C.3-K.3",
	      "C.6-K.6",
	      "C.9-K.9",
	      "C.12-K.12",
	      "C.18-K.18",
	      "C.24-K.24",
	      "C.30-K.30",
	      "C.48-K.48",
	      "C.60-K.60",
	      "C.120-K.120",
	      "C.168-K.168")
	
meta$WeeklyGroup = make.names(meta$Group:as.factor(meta$Time))
# de_analysis =  fit_weekly_analysis(
#     data, meta, contrasts,
#     use_voom_weights=FALSE)
```

# Clustering

FIXME should use a package with a smarter initialization (kmeans++)

```{r}
if(filter_genes){
    # Filter out q-values for the pvalues table
    col_to_keep = colnames(pvalues)[grepl("-pval", colnames(pvalues))]
    pvalues = pvalues[, col_to_keep]
    fishers_pval = fisher_method(pvalues)
    genes_to_keep = names(sort(fishers_pval)[1:n_genes_to_keep])
    y = as.matrix(data[genes_to_keep, ])
}else{
    y = as.matrix(data)
}

###############################################################################
# Fit the splines

full_model = ~Group:ns(Time, df=df) + Group + 0
X = model.matrix(full_model, data=meta)

fitted_data = fit_predict_splines(y, X)
rescaled_fitted_data = rescale_values(fitted_data, meta)

kmeans_clusters = kmeans(rescaled_fitted_data, n_clusters, nstart=10)
all_scores = data.frame(row.names=row.names(data))
for(k in 1:n_clusters){
    scores = score_genes_centroid(data, kmeans_clusters$centers[k,])
    all_scores[paste0("cluster_", k)] = scores
}

# Only assign labels to X% of the genes
max_score = quantile(row_min(all_scores), c(percentage_genes_to_label))
genes_to_not_consider = row_min(all_scores) >= max_score
labels = row_argmin(all_scores)
labels[genes_to_not_consider] = NA
```

# Downstream analysis


```{r}

```
