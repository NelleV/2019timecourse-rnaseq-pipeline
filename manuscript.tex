\documentclass[9pt,a4paper,]{extarticle}

\usepackage{f1000_styles}

\usepackage[pdfborder={0 0 0}]{hyperref}

\usepackage[numbers]{natbib}
\bibliographystyle{unsrtnat}


%% maxwidth is the original width if it is less than linewidth
%% otherwise use linewidth (to make sure the graphics do not exceed the margin)
\makeatletter
\def\maxwidth{ %
  \ifdim\Gin@nat@width>\linewidth
    \linewidth
  \else
    \Gin@nat@width
  \fi
}
\makeatother

\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}

% disable code chunks background
%\renewenvironment{Shaded}{}{}

% disable section numbers
\setcounter{secnumdepth}{0}

%% added by MLS, this is not in the F1000 style by default %%

\hypersetup{unicode=true,
            pdftitle={A pipeline to analyse time-course gene expression data},
            pdfkeywords={time-course gene expression data, clustering, differential expression, workflow},
            pdfborder={0 0 0},
            breaklinks=true}

%% End added by MLS %%

\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}


\usepackage{float}

\begin{document}
\pagestyle{front}

\title{A pipeline to analyse time-course gene expression data}

%% AUTH AFFIL %%

\maketitle
\thispagestyle{front}

\begin{abstract}
The phenotypic diversity of cells is governed by a complex equilibrium between their genetic identity and their environmental interactions: Understanding the dynamics of gene expression is a fundamental question of biology. However, analysing time-course transcriptomic data raises unique challenging statistical and computational questions, requiring the development of novel methods and software. Using as case study time-course transcriptomics data from mice exposed to different strains of influenza, this workflow provides a step-by-step tutorial of the methodology used to analyse time-course data: (1) quality control and normalization of the dataset; (2) differential expression analysis using functional data analysis; (3) clustering of time-course data; (4) interpreting clusters with GO term and KEGG pathway enrichment analysis.
\end{abstract}

\section*{Keywords}
time-course gene expression data, clustering, differential expression, workflow


\clearpage
\pagestyle{main}

\hypertarget{introduction}{%
\section{Introduction}\label{introduction}}

Gene expression studies provide simultaneous quantification of the level of
mRNA from all genes in a sample. High-throughput studies of gene expression
have a long history, starting with microarray technologies in the 1990s
through to single-cell technologies. While many expression studies are
designed to compare the gene expression between distinct groups, there is also a
long history of time-course expression studies. Such studies compare the
gene expression
across time by measuring mRNA levels from samples collected at different
timepoints \footnote{Because the collection of the mRNA is often destructive, samples at
  different time points are generally from different biological samples;
  longitudinal studies, for example tracking the same subject over time, are
  certainly possible, but not directly considered here.}. Such time-course studies can vary from measuring a few
distinct time
points, to sampling ten to twenty time points. These longer time series are
particularly interested in investigating development over time. More recently,
a new variety of time course studies have come from single-cell sequencing experiments
\citep{shalek:single-cell, habib:div-seq, trapnell:dynamics}
which can sequence single cells at different stages of development; in this case,
the time point is the stage of the cell in the process of development -- a
value that is not know but estimated from the data as its ``pseudo-time.''

While there are many methods that have been proposed for discrete aspects of
time course data, the entire workflow for analysis of such data remains
difficult, particularly for long, developmental time series. Most methods
proposed for time course data are concerned with detecting genes that are
changing over time (differential expression analysis), examples being \texttt{edge}
\citep{storey:significance}, functional component analysis based models \citep{wu:more},
time-course permutation tests \citep{park:statistical}, and multiple testing
strategies to combine single time point differential expression analysis
\citep{sun:multiple}. However, with long time course datasets, particularly in
developmental systems, a massive number of genes will show \emph{some} change. For
example, in a study of mice lung tissues infected with influenza that we
consider in this workflow, over 50\% of genes
are shown to be changing over time. The task in these settings is often not to
detect changes in genes, but to categorize them into biologically interpretable
patterns.

We present here a workflow for such an analysis that consists of 4 main
parts (Figure \ref{fig:schema}):

\begin{itemize}
\tightlist
\item
  Quality control and normalization;
\item
  Identification of genes that are differentially expressed;
\item
  Clustering of genes into distinct temporal patterns;
\item
  Biological interpretation of the clusters.
\end{itemize}

This workflow represents an integration of both novel implementations of
previously established methods and new methodologies for the settings of
developmental time series. It relies on several standard packages for
analysing gene expression data, some specific for time-course data, others
broadly used by the community. We provide the various steps of the workflow as
functions in a R package called \texttt{moanin}.

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{images/fig1_schemas} 

}

\caption{Workflow for analyzing time-course datasets.}\label{fig:schema}
\end{figure}

\hypertarget{installation-and-setup}{%
\subsection{Installation and setup}\label{installation-and-setup}}

\texttt{moanin} and \texttt{timecoursedata} are available from bioconductor, and can be
installed using the \texttt{install} function in the package \texttt{BiocManager}, along
with the corresponding package that contains time course datasets we will use:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(BiocManager)}
\CommentTok{# Need to use the development version for now.}
\NormalTok{BiocManager}\OperatorTok{::}\KeywordTok{install}\NormalTok{(}\DataTypeTok{version=}\StringTok{"devel"}\NormalTok{)}
\NormalTok{BiocManager}\OperatorTok{::}\KeywordTok{valid}\NormalTok{()}

\NormalTok{BiocManager}\OperatorTok{::}\KeywordTok{install}\NormalTok{(}\StringTok{"timecoursedata"}\NormalTok{)}
\NormalTok{BiocManager}\OperatorTok{::}\KeywordTok{install}\NormalTok{(}\StringTok{"moanin"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The following additional packages are needed for this workflow:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# From Github}
\KeywordTok{library}\NormalTok{(moanin)}
\KeywordTok{library}\NormalTok{(timecoursedata)}

\CommentTok{# From CRAN}
\KeywordTok{library}\NormalTok{(NMF)}
\KeywordTok{library}\NormalTok{(ggfortify)}

\CommentTok{# From Bioconductor}
\KeywordTok{library}\NormalTok{(topGO)}
\KeywordTok{library}\NormalTok{(biomaRt)}
\KeywordTok{library}\NormalTok{(KEGGprofile)}
\KeywordTok{library}\NormalTok{(BiocWorkflowTools) }\CommentTok{#Needed for compiling the .Rmd script}
\end{Highlighting}
\end{Shaded}

If Bioconductor is installed, the CRAN and Bioconductor packages above can be installed via

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{BiocManager}\OperatorTok{::}\KeywordTok{install}\NormalTok{(}
    \KeywordTok{c}\NormalTok{(}\StringTok{"NMF"}\NormalTok{, }\StringTok{"ggfortify"}\NormalTok{, }\StringTok{"topGO"}\NormalTok{, }\StringTok{"biomaRt"}\NormalTok{,}
      \StringTok{"KEGGprofile"}\NormalTok{, }\StringTok{"BiocWorkflowTools"}\NormalTok{, }\StringTok{"timecoursedata"}\NormalTok{, ))}
\end{Highlighting}
\end{Shaded}

\hypertarget{analysis-of-the-dynamical-response-of-mouse-lung-tissue-to-influenza}{%
\section{Analysis of the dynamical response of mouse lung tissue to influenza}\label{analysis-of-the-dynamical-response-of-mouse-lung-tissue-to-influenza}}

This workflow is illustrated using data from a micro-array time-course
experiment, exposing mice to three different strains of influenza, and
collecting lung tissue during 14 time-points after infection (0, 3, 6, 9, 12,
18, 24, 30, 36, 48, 60 hours, then 3, 5, and 7 days later)
\citep{shoemaker:ultrasensitive}. The three strains of influenza used in the
study are (1) a low pathogenicity seasonal H1N1 influenza virus
(A/Kawasaki/UTK4/2009 {[}H1N1{]}), a mildly pathogenic virus from the 2009
pandemic season (A/California/04/2009 {[}H1N1{]}), and a highly pathogenic H5N1
avian influenza virus (A/Vietnam/1203/2004 {[}H5N1{]}. Mice were injected with
\(10^5\) PFU of each virus. An additional 42 mice were injected with a lower dose
of the Vietnam avian influenza virus (\(10^3\) PFU).

By combining gene expression time-course data with virus growth data, the
authors show that the inflammatory response of lung tissue is gated until a
threshold of the virus concentration is exceeded in the lung. Once this
threshold is exceeded, a strong inflammatory and cytokine production occurs.
This results provides evidence that the pathology response is non-linearly
regulated by virus concentration.

While we showcase this pipeline on micro-array data,
\citep{varoquaux:transcriptomic}
leverages a similar set of steps to analyse RNA-seq data of the lifetime
transcriptomic response of the crop \emph{S. bicolor} to drought.

\hypertarget{overview-of-the-data}{%
\subsection{Overview of the data}\label{overview-of-the-data}}

First let's load the data. The package \texttt{moanin} contains the normalized
data and metadata of \citep{shoemaker:ultrasensitive}.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Now load in the metadata}
\KeywordTok{data}\NormalTok{(shoemaker2015)}
\NormalTok{meta =}\StringTok{ }\NormalTok{shoemaker2015}\OperatorTok{$}\NormalTok{meta}
\NormalTok{data =}\StringTok{ }\NormalTok{shoemaker2015}\OperatorTok{$}\NormalTok{data}
\end{Highlighting}
\end{Shaded}

The meta data contains information about the treatment group, the replicate,
and the timepoint for each observation:

\begin{longtable}[]{@{}ccccc@{}}
\toprule
\begin{minipage}[b]{0.20\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.11\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.10\columnwidth}\centering
Group\strut
\end{minipage} & \begin{minipage}[b]{0.14\columnwidth}\centering
Replicate\strut
\end{minipage} & \begin{minipage}[b]{0.14\columnwidth}\centering
Timepoint\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.20\columnwidth}\centering
\textbf{GSM1557140}\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0\strut
\end{minipage} & \begin{minipage}[t]{0.10\columnwidth}\centering
K\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
0\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.20\columnwidth}\centering
\textbf{GSM1557141}\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.10\columnwidth}\centering
K\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
0\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.20\columnwidth}\centering
\textbf{GSM1557142}\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.10\columnwidth}\centering
K\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
0\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.20\columnwidth}\centering
\textbf{GSM1557143}\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.10\columnwidth}\centering
K\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
12\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.20\columnwidth}\centering
\textbf{GSM1557144}\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
4\strut
\end{minipage} & \begin{minipage}[t]{0.10\columnwidth}\centering
K\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
12\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.20\columnwidth}\centering
\textbf{GSM1557145}\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.10\columnwidth}\centering
K\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
12\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

Before we dive into the exploratory analysis and quality control, let us
define color schemes for our data that we will use across the whole analysis.
We define color schemes for groups and time points as named vectors. We also
define a series of markers (or plotting symbols) to distinguish replicate
samples in scatter plots. We also reorder the factor \texttt{Group} which describes the treatments so that the treatments are order from low to high pathogeny (with Control being first).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{group_colors =}\StringTok{ }\KeywordTok{c}\NormalTok{(}
    \StringTok{"M"}\NormalTok{=}\StringTok{"dodgerblue4"}\NormalTok{,}
    \StringTok{"K"}\NormalTok{=}\StringTok{"gold"}\NormalTok{,}
    \StringTok{"C"}\NormalTok{=}\StringTok{"orange"}\NormalTok{,}
    \StringTok{"VH"}\NormalTok{=}\StringTok{"red4"}\NormalTok{,}
    \StringTok{"VL"}\NormalTok{=}\StringTok{"red2"}\NormalTok{)}
\NormalTok{time_colors =}\StringTok{ }\NormalTok{grDevices}\OperatorTok{::}\KeywordTok{rainbow}\NormalTok{(}\DecValTok{15}\NormalTok{)[}\DecValTok{1}\OperatorTok{:}\DecValTok{14}\NormalTok{]}
\KeywordTok{names}\NormalTok{(time_colors) =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{12}\NormalTok{, }\DecValTok{18}\NormalTok{, }\DecValTok{24}\NormalTok{, }\DecValTok{30}\NormalTok{, }\DecValTok{36}\NormalTok{, }\DecValTok{48}\NormalTok{, }\DecValTok{60}\NormalTok{, }\DecValTok{72}\NormalTok{, }\DecValTok{120}\NormalTok{, }\DecValTok{168}\NormalTok{)}

\CommentTok{# Combine all color schemes into one named lists.}
\NormalTok{ann_colors =}\StringTok{ }\KeywordTok{list}\NormalTok{(}
    \DataTypeTok{Timepoint=}\NormalTok{time_colors,}
    \DataTypeTok{Group=}\NormalTok{group_colors}
\NormalTok{    )}

\NormalTok{replicate_markers =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{15}\NormalTok{, }\DecValTok{17}\NormalTok{, }\DecValTok{19}\NormalTok{)}
\KeywordTok{names}\NormalTok{(replicate_markers) =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\NormalTok{ann_markers =}\StringTok{ }\KeywordTok{list}\NormalTok{(}
    \DataTypeTok{Replicate=}\NormalTok{replicate_markers)}

\CommentTok{# Reorder the conditions such that:}
\CommentTok{#   - Control is before any influenza treatment}
\CommentTok{#   - Each treatment is ordered from low to high pathogeny}
\NormalTok{meta}\OperatorTok{$}\NormalTok{Group =}\StringTok{ }\KeywordTok{factor}\NormalTok{(meta}\OperatorTok{$}\NormalTok{Group, }\KeywordTok{levels}\NormalTok{(meta}\OperatorTok{$}\NormalTok{Group)[}\KeywordTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{4}\NormalTok{)])}
\end{Highlighting}
\end{Shaded}

\hypertarget{quality-control-and-normalization}{%
\subsection{Quality control and normalization}\label{quality-control-and-normalization}}

The first steps of analysis of gene expression data is always to do
normalization and quality control checks of the data. However, in what
follows, we do not show the steps for normalization, as these are specific to
the platform (microarray); the code for the normalization can be found in as a
supplemental file \citep{abrams:protocol, park:evaluation}.

Instead, we focus on common steps for exploratory analysis of the data, including for the purpose of quality control. These steps
are not specific to time course data, but could be applied for any gene expression
analysis. For this reason, we will not print the detailed code that is needed for this part of the analysis; interested readers can examine the \texttt{rmarkdown} code that accompanies this workflow.

\hypertarget{exploratory-analysis-and-quality-control}{%
\subsubsection{Exploratory analysis and quality control}\label{exploratory-analysis-and-quality-control}}

Typically, two quality control and exploratory analysis steps are
performed before and after normalization: (1) low dimensionality embedding of
the samples; (2) correlation plots between each samples. In both cases, we
expect a strong biological signal, while replicate samples should be strongly
clustered or correlated with one another.

Before performing any additional exploratory analysis, let us only keep highly
variable genes: for this step, we keep only the top 50\% most variable genes.
In Figure \ref{fig:geneVarHist}, we plot the distribution of variance across
all genes.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{variance_cutoff =}\StringTok{ }\FloatTok{0.5}
\CommentTok{# Filter genes by median absolute deviation (mad)}
\NormalTok{variance_per_genes =}\StringTok{ }\KeywordTok{apply}\NormalTok{(data, }\DecValTok{1}\NormalTok{, mad)}
\NormalTok{min_variance =}\StringTok{ }\KeywordTok{quantile}\NormalTok{(variance_per_genes, }\KeywordTok{c}\NormalTok{(variance_cutoff))}
\NormalTok{variance_filtered_data =}\StringTok{ }\NormalTok{data[variance_per_genes }\OperatorTok{>}\StringTok{ }\NormalTok{min_variance,]}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/geneVarHist-1} 

}

\caption{Distribution of variance}\label{fig:geneVarHist}
\end{figure}

Let us first perform the PCA analysis. Here, we perform a PCA of rank 3 of the
centered and scaled gene expression data.

In Figure \ref{fig:pcaPlots}, we visualize the data by plotting the PC components, with samples colored by either its
condition (top row) or its sampling time (bottom row) and each replicate a different symbol. We can see a large difference in later time points.

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/pcaPlots-1} 

}

\caption{Plot of PC components: PC2 vs PC1 (right) and PC2 vs PC3 (left). Samples are colored by condition (top row) and sampling time (bottom row).}\label{fig:pcaPlots}
\end{figure}

We also plot in Figure \ref{fig:correlationPlot} the pearson correlation between each sample as a heatmap diagram (using the function \texttt{aheatmap} in \texttt{NMF}). We order the
samples by their Group (treatment) and Timepoint (the time of sampling).

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/correlationPlot-1} 

}

\caption{Heatmap of the correlation between samples}\label{fig:correlationPlot}
\end{figure}

We can already see interesting patterns emerging from the correlation plot.
First, the cross-correlation amongst samples taking from the control mice is
higher than the cross correlation amongst the rest of the treatments. Second,
the influenza-infected mice mildly react until time point 36. Third, the less
pathogenic the strain is, the closer the samples are to the control condition.
Fourth, the Vietnam samples at time point 120 and 168 are the one that are the
most different from control samples.

\hypertarget{differential-expression-analysis-of-time-course-data}{%
\subsection{Differential expression analysis of time-course data}\label{differential-expression-analysis-of-time-course-data}}

\hypertarget{approaches-to-de-analysis-in-time-course-data}{%
\subsubsection{Approaches to DE analysis in time-course data}\label{approaches-to-de-analysis-in-time-course-data}}

The next step in a gene expression analysis is typically to run a differential
expression analysis, generally to find genes different between different
conditions. For time-course data, there are two different approaches for
determining differentially expressed genes,

\begin{enumerate}
\def\labelenumi{\arabic{enumi})}
\item
  Per-time point analysis, where we consider each time point a different
  condition and determine what genes are changing between specific time points, or
  between conditions at a single time-point.
\item
  Global analysis, where we consider the expression pattern globally over
  time, and consider what genes have either different patterns between
  conditions or a changing pattern (i.e.~non-constant) over time. A common
  approach first step is to fit a spline model to each gene
  \citep{storey:significance}, and then use that spline model to test for different
  kinds of differential expression across time.
\end{enumerate}

The per-time point analysis is using classical differential expression
approaches, and is often the approach advocated when dealing with small
time-course datasets, where there are only a few time points \citep{ritchie:limma, robinson:edgeR, love:moderated}. For long time-course datasets, however, a
separate test for each time-point results in creating many different tests,
for example one for every time point, the results of which are difficult to
integrate. We find in practice that the global analysis simplifies analysis
and interpretation of longer time courses data, with per-time point analysis
reserved for particularly interesting comparisons of individual time-points.

Time course data can either be on a single condition (to identify genes
changing over time) or on multiple conditions (such as the influenza
dataset we are considering), which will alter slightly the types of questions
we are interested in.

\textbf{DE Analysis in \texttt{moanin}} Our package \texttt{moanin} provides functionality for performing both of
these types of approaches, though our focus is on the global approach, specifically by fitting spline models to the genes.

In both
situations, we first need to set up a object (a \texttt{Moanin} object) to
hold the meta data, as well as information for fitting the spline model
(formula, number of degrees of freedom of the splines, \ldots{}). The \texttt{Moanin} object
will contain information used
throughout this analysis, in particular the condition and timepoints of each sample and the
the basis matrix for fitting splines models.

We start by creating the \texttt{Moanin} object using the \texttt{create\_moanin\_model}
function. We need to provide two things to the function: a \texttt{data.frame} with
the metadata, and the number of degrees of freedom of the splines to be used in the
functional modeling. The metadata \texttt{data.frame} object should contain at least
two columns: one named \texttt{Group}, containing the treatement effect, and a
second one named \texttt{Timepoint} containing the timepoint information.

\begin{longtable}[]{@{}ccccc@{}}
\toprule
\begin{minipage}[b]{0.20\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.11\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.10\columnwidth}\centering
Group\strut
\end{minipage} & \begin{minipage}[b]{0.14\columnwidth}\centering
Replicate\strut
\end{minipage} & \begin{minipage}[b]{0.14\columnwidth}\centering
Timepoint\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.20\columnwidth}\centering
\textbf{GSM1557140}\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0\strut
\end{minipage} & \begin{minipage}[t]{0.10\columnwidth}\centering
K\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
0\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.20\columnwidth}\centering
\textbf{GSM1557141}\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.10\columnwidth}\centering
K\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
0\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.20\columnwidth}\centering
\textbf{GSM1557142}\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.10\columnwidth}\centering
K\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
0\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.20\columnwidth}\centering
\textbf{GSM1557143}\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.10\columnwidth}\centering
K\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
12\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.20\columnwidth}\centering
\textbf{GSM1557144}\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
4\strut
\end{minipage} & \begin{minipage}[t]{0.10\columnwidth}\centering
K\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
12\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.20\columnwidth}\centering
\textbf{GSM1557145}\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.10\columnwidth}\centering
K\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
12\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

We create a \texttt{Moanin} object for our data:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{moanin_model =}\StringTok{ }\KeywordTok{create_moanin_model}\NormalTok{(}\DataTypeTok{data=}\NormalTok{data, }\DataTypeTok{meta=}\NormalTok{meta,}
    \DataTypeTok{degrees_of_freedom=}\DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The main operation of the \texttt{create\_moanin\_model} function, in addition to holding the necessary meta data of the samples,
is to create a basis matrix for the splines fit. This matrix gives the evaluation of all of the spline basis functions for
each sample (as such, replicate samples will have the same
values). By default, \texttt{create\_moanin\_model} will create the spline basis functions which will lead to a different spline fit for every group (as defined by the \texttt{Group} variable
in the \texttt{meta} data.frame). This is done by the following \texttt{R} formula syntax:

\texttt{formula\ =\ \textasciitilde{}Group:ns(Timepoint,\ df=degrees\_of\_fredoom)\ +\ Group\ +\ 0}.

Alternatively, the user can provide a formula of their own, or simply provide the basis matrix themselves.

We can see this information when we print the object:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{show}\NormalTok{(moanin_model)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Moanin object on 209 samples containing the following information:
## Group variable given by 'Group' with the following levels:
##  M  K  C VL VH 
## 42 42 42 42 41 
## Time variable given by 'Timepoint'
## Basis matrix with 35 basis_matrix functions
## Basis matrix was constructed with the following spline_formula
## ~Group + Group:splines::ns(Timepoint, df = 6) + 0 
## 
## Information about the data (a SummarizedExperiment object):
## class: SummarizedExperiment 
## dim: 39544 209 
## metadata(0):
## assays(1): ''
## rownames(39544): NM_009912 NM_008725 ... NM_010201.1 AK078781
## rowData names(0):
## colnames(209): GSM1557140 GSM1557141 ... GSM1557347 GSM1557348
## colData names(5): '' Group Replicate Timepoint WeeklyGroup
\end{verbatim}

The \texttt{Moanin} class extends the \texttt{SummarizedExperiment} class of Bioconductor, so that the data as well as the meta data and our spline information are all held in one object. This means that the object can be subsetted just like the data matrix, and the corresponding meta data and basis function evaluations will be similarly subsetted:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{dim}\NormalTok{(moanin_model)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 39544   209
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{moanin_model[}\DecValTok{1}\OperatorTok{:}\DecValTok{10}\NormalTok{,}\DecValTok{1}\OperatorTok{:}\DecValTok{3}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Moanin object on 3 samples containing the following information:
## Group variable given by 'Group' with the following levels:
##  M  K  C VL VH 
##  0  3  0  0  0 
## Time variable given by 'Timepoint'
## Basis matrix with 35 basis_matrix functions
## Basis matrix was constructed with the following spline_formula
## ~Group + Group:splines::ns(Timepoint, df = 6) + 0 
## 
## Information about the data (a SummarizedExperiment object):
## class: SummarizedExperiment 
## dim: 10 3 
## metadata(0):
## assays(1): ''
## rownames(10): NM_009912 NM_008725 ... NM_013782 NM_028622
## rowData names(0):
## colnames(3): GSM1557140 GSM1557141 GSM1557142
## colData names(5): '' Group Replicate Timepoint WeeklyGroup
\end{verbatim}

\hypertarget{weekly-differential-expression-analysis}{%
\subsubsection{Weekly differential expression analysis}\label{weekly-differential-expression-analysis}}

\texttt{moanin} provides a simple interface to perform a timepoint by timepoint
differential expression analysis. Comparison between groups is traditionally
done by defining the group comparisons (called \texttt{contrasts} in linear models)
as a linear combination of the coefficients of the model. Comparing groups
within each timepoint can create many contrasts, and thus \texttt{moanin} provides
functionality to create these contrasts in an automatic way, and then calls
\texttt{limma} \citep{ritchie:limma} on the set of contrasts provided. By default,
\texttt{moanin} expects RNA-Seq gene counts, and will estimate voom weights.

Here, we show an example where we create contrasts that will be be the difference
between the control mouse (``M'') and the mouse infected with the high dose of
the influenza strain A/Vietnam/1203/04 (H5N1) (``VL'') for each time point (but
the function works with any form contrasts \citep{ritchie:limma}).

First, create the contrasts for all timepoints between the two groups of
interest:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Define contrasts  }
\NormalTok{contrasts =}\StringTok{ }\KeywordTok{create_timepoints_contrasts}\NormalTok{(moanin_model,}\StringTok{"M"}\NormalTok{, }\StringTok{"VL"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

This creates a character vector of contrasts to be tested, one for each timepoint, in the format required by \texttt{limma}:

\begin{verbatim}
## [1] "M.0-VL.0"   "M.3-VL.3"   "M.6-VL.6"   "M.9-VL.9"   "M.12-VL.12"
\end{verbatim}

Then \texttt{moanin} will run the differential expression analysis on all of those timepoints
jointly using the function \texttt{DE\_timepoints}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weekly_de_analysis =}\StringTok{ }\KeywordTok{DE_timepoints}\NormalTok{( moanin_model, contrasts,}
     \DataTypeTok{use_voom_weights=}\OtherTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The output is a table of results, where each row corresponds to a gene and the
columns correspond to the p-value (\texttt{pval}), log-fold change (\texttt{lfc}) and
adjusted p-value (\texttt{qval}) of the sets of contrasts; the order of the genes in
the table is the same as the input \texttt{data}. Here we show the results for the
first timepoint (i.e.~first three columns of the output) and the first ten
genes:

\begin{longtable}[]{@{}cccc@{}}
\toprule
\begin{minipage}[b]{0.30\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.19\columnwidth}\centering
M.0-VL.0\_pval\strut
\end{minipage} & \begin{minipage}[b]{0.19\columnwidth}\centering
M.0-VL.0\_qval\strut
\end{minipage} & \begin{minipage}[b]{0.19\columnwidth}\centering
M.0-VL.0\_lfc\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.30\columnwidth}\centering
\textbf{NM\_009912}\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.2728\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.4746\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
2.202\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.30\columnwidth}\centering
\textbf{NM\_008725}\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.8509\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.9243\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
2.028\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.30\columnwidth}\centering
\textbf{NM\_007473}\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.08804\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.2193\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.678\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.30\columnwidth}\centering
\textbf{ENSMUST00000094955}\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.008188\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.0368\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
1.186\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.30\columnwidth}\centering
\textbf{NM\_001042489}\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.4192\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.6208\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
1.212\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.30\columnwidth}\centering
\textbf{NM\_008159}\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.1232\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.2778\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
1.102\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.30\columnwidth}\centering
\textbf{NM\_001013813}\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.05653\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.1594\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.63\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.30\columnwidth}\centering
\textbf{AK039774}\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.01504\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.05902\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.6372\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.30\columnwidth}\centering
\textbf{NM\_013782}\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.8754\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.9377\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.594\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.30\columnwidth}\centering
\textbf{NM\_028622}\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.7668\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
0.8759\strut
\end{minipage} & \begin{minipage}[t]{0.19\columnwidth}\centering
1.648\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

Additional timepoints are in the additional columns of the output.

We will repeat this, comparing each of the remaining three treatments to the
control (``M'') (code not printed here, as it is a replicate of the above, see
accompanying Rmarkdown document).

In Figure \ref{fig:timeSignifPerTime}, we show the distribution of genes found differentially expressed per
week between control and each of the influenza strains. Such an analysis can demonstrate some general trends, with clearly more genes
being differentially expressed at later time points, and the Vietnam high-dose
showing perhaps an earlier onset than the low-dose.

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/timeSignifPerTime-1} 

}

\caption{Number of genes found DE in each timepoint when comparing the influenza strains to control.}\label{fig:timeSignifPerTime}
\end{figure}

However, the distribution of the number of genes found differentially
expressed by considering each time-point independently highlights the
challenges of such approach. We can see that some timepoints have many less
genes found significantly differentially expressed (e.g.~timepoint 6H and 18H
of the Kawasaki strain). While there may be biological differences at those
time points for some genes, it seems unlikely that the large majority of genes
differentially expressed at timepoint 3H stop being differentially expressed
at 6H and then jump back to being differentially expressed at 9H. A more
likely explanation is that there is are some technical or biological artifact
about the samples for 6H that is creating higher variation and thus less
ability to detect significance.

Another difficulty with such an approach is making sense of the general
temporal structure for any particular gene, as different genes will have
different combinations of timepoints DE. For the comparison of the Kawasaki
strain to the control, for example, there are 26534 genes
found DE in some timepoints, and there are 1590 different
combinations of timepoints for which they are DE. Some of these make sense,
such as DE in timepoints 48H-168H (509 genes), but
many are very fragmentary. For example there are 330
genes which are DE in timepoints 48,60,120,168H, but \emph{not} in the 72H. Many of
these genes are likely to have not made the cutoff for significance in 72H,
but don't show real differences in the overall trend between 48H-168H. In Figure \ref{fig:showMissingDEGenes} we show the plots of the first 10 such genes. We can see that some might
show some meaningful changes between 60 and 72H, but others clearly just have
a single replicate that is different or increased variability at 72H that results in a lack of significance in 72H.

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/showMissingDEGenes-1} 

}

\caption{The expression values over time for 10 genes found significant DE in timepoints 48,60,120,168H, but not in the 72H timepoint.}\label{fig:showMissingDEGenes}
\end{figure}

As a summary, classic differential expression methods are appropriate for
unordered treatments, but fail to make use of the temporal structure of the data.

\hypertarget{time-course-differential-expression-analysis-between-two-groups}{%
\subsubsection{Time-course differential expression analysis between two groups}\label{time-course-differential-expression-analysis-between-two-groups}}

To leverage this temporal structure, Storey et al \citep{storey:significance}
proposed to model each gene in time-course micro-array with a splines
function, and to use a log-ratio likelihood test to detect differentially
expressed genes.

\texttt{moanin} extends this idea by not only fitting a splines function for each gene, but also providing functionality to compare time course
data between different treatment conditions, using a similar mechanism of
contrasts -- only now the contrasts are differences between the estimated mean
functions. This is done with the function \texttt{DE\_timecourse}, which takes as
similar input that of \texttt{DE\_timepoints}, only now will fit spline functions for each gene and test the entire mean
function (and unlike \texttt{DE\_timepoints}, therefore does not require the extra step of expanding the contrasts into contrasts for individual timepoints).

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Differential expression analysis}
\NormalTok{timecourse_contrasts =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"M-K"}\NormalTok{, }\StringTok{"M-C"}\NormalTok{, }\StringTok{"M-VL"}\NormalTok{, }\StringTok{"M-VH"}\NormalTok{)}

\CommentTok{# The function takes the data (data.frame or named matrix), the meta data}
\CommentTok{# (data.frame containing a timepoint and group column, the first corresponding}
\CommentTok{# to the time-course information, the latter corresponding to the}
\CommentTok{# treatment).}
\NormalTok{DE_results =}\StringTok{ }\KeywordTok{DE_timecourse}\NormalTok{( moanin_model, timecourse_contrasts,}
    \DataTypeTok{use_voom_weights=}\OtherTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The output from \texttt{DE\_timecourse} is a matrix of (raw) p-values and Benjamini-Hochberg corrected q-values for each comparison.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{names}\NormalTok{(DE_results)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "M-K_pval"  "M-K_qval"  "M-C_pval"  "M-C_qval"  "M-VL_pval" "M-VL_qval"
## [7] "M-VH_pval" "M-VH_qval"
\end{verbatim}

For convenience we will separate these into two matrices.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pval_columns =}\StringTok{ }\KeywordTok{colnames}\NormalTok{(DE_results)[}
    \KeywordTok{grepl}\NormalTok{(}\StringTok{"pval"}\NormalTok{, }\KeywordTok{colnames}\NormalTok{(DE_results))]}
\NormalTok{qval_columns =}\StringTok{ }\KeywordTok{colnames}\NormalTok{(DE_results)[}
    \KeywordTok{grepl}\NormalTok{(}\StringTok{"qval"}\NormalTok{, }\KeywordTok{colnames}\NormalTok{(DE_results))]}
\NormalTok{pvalues =}\StringTok{ }\NormalTok{DE_results[, pval_columns]}
\NormalTok{qvalues =}\StringTok{ }\NormalTok{DE_results[, qval_columns]}
\end{Highlighting}
\end{Shaded}

The number of genes found differentially expressed ranges from around 12000 to
29000 depending on the strain and dosage of influenza virus given to the mice
(Figure \ref{deTimeDist}).
This corresponds to between 30\% to 70\% of the genes found differentially
expressed in this time-course experiment.

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/deTimeDist-1} 

}

\caption{Distribution of DE genes per condition based on global splines analysis}\label{fig:deTimeDist}
\end{figure}

\hypertarget{log-fold-change-for-time-course-data}{%
\subsubsection{Log-fold Change for Time Course Data}\label{log-fold-change-for-time-course-data}}

The next step in a classical differential expression analysis is typically to
assess the effect of the treatment by calculating for each gene the log fold change in the gene expression between the treatment and control.

Computing the log fold change on a time-course experiment is not trivial: one
can be interested in the average log-fold change across time, or the
cumulative log-fold change. Sometimes a gene can be over-expressed at the
beginning of the time-course data, and then under-expressed at the end of the
experiment. As a result, \texttt{moanin} provides a number of possible ways to
compute the log fold change across the whole time-course. This is done via the function \texttt{estimate\_log\_fold\_change} which takes as
arguments the data, the \texttt{Moanin} object, the contrasts to evaluate, and the method to use to estimate the log-fold change.

\textbf{Individual Timepoints} The first method (``timely'') gives a simple interface to compute the log-fold change
for each individual timepoints.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{log_fold_change_timepoints =}\StringTok{ }\KeywordTok{estimate_log_fold_change}\NormalTok{(}
\NormalTok{    moanin_model, timecourse_contrasts,  }\DataTypeTok{method=}\StringTok{"timely"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}cccccc@{}}
\toprule
\begin{minipage}[b]{0.26\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.11\columnwidth}\centering
M-K:0\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
M-K:3\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
M-K:6\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
M-K:9\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
M-K:12\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.26\columnwidth}\centering
\textbf{NM\_009912}\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
-0.5662\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.2455\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.4097\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.332\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.05026\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.26\columnwidth}\centering
\textbf{NM\_008725}\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
0.9947\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-3.461\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.6561\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-1.211\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.1999\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.26\columnwidth}\centering
\textbf{NM\_007473}\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
-0.5177\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.3147\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.2328\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.3446\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.04762\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.26\columnwidth}\centering
\textbf{ENSMUST00000094955}\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
-0.2202\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.2567\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.03584\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.04697\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.07075\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.26\columnwidth}\centering
\textbf{NM\_001042489}\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
-0.2476\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.2044\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.3428\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.3931\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.4822\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.26\columnwidth}\centering
\textbf{NM\_008159}\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\centering
-0.7466\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.06789\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.3072\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.7067\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.4967\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

This matrix can then be used to visualize the log-fold change for each
contrast per timepoint.

\textbf{Cumulative Effect} Sometimes, a single value per gene for each contrast is more useful, and \texttt{estimate\_log\_fold\_change} used above provides several options for this as well. Here is a
table of the possible ways \texttt{estimate\_log\_fold\_change} can compute log-fold change values (including \texttt{timely} discussed above).

\begin{longtable}[]{@{}lll@{}}
\toprule
Name & Formula &\tabularnewline
\midrule
\endhead
timely & \(\text{lfc}(t)\) & Per time point\tabularnewline
sum & \(\sum_t \text{lfc}(t)\) & Sum of log fold change.\tabularnewline
abs\_sum & \(\sum_t \lvert \text{lfc}(t)\lvert\) & Always positive\tabularnewline
max & \(\max_t \lvert \text{lfc}(t) \lvert\) & Always positive\tabularnewline
min & \(\min_t \lvert \text{lfc}(t) \lvert\) & Always positive\tabularnewline
timecourse & See details below & Captures overall strength \emph{and} direction\tabularnewline
\bottomrule
\end{longtable}

The method ``timecourse'' tries to capture the overall strength and direction of the response in the following way: we leverage the
timepoint by timepoint log-fold change \(\text{lfc}(t)\), and apply the
following formula:

\[\text{sign}\left(\frac{1}{T}\sum_{t = 1}^T \text{lfc}(t) \right) \times \left(\frac{1}{T}\sum_{t= 1}^T \lvert {\text{lfc}(t)} \lvert \right)\]

Note, however, that when a gene is not consistently up or down-regulated the estimation
of the direction will not represent accurately the changes observed.

We demonstrate several of these methods on our data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{log_fold_change_timecourse =}\StringTok{ }\KeywordTok{estimate_log_fold_change}\NormalTok{(}
\NormalTok{    moanin_model, timecourse_contrasts,  }\DataTypeTok{method=}\StringTok{"timecourse"}\NormalTok{)}

\NormalTok{log_fold_change_sum =}\StringTok{ }\KeywordTok{estimate_log_fold_change}\NormalTok{(}
\NormalTok{    moanin_model, timecourse_contrasts,  }\DataTypeTok{method=}\StringTok{"sum"}\NormalTok{)}

\NormalTok{log_fold_change_max =}\StringTok{ }\KeywordTok{estimate_log_fold_change}\NormalTok{(}
\NormalTok{    moanin_model, timecourse_contrasts, }\DataTypeTok{method=}\StringTok{"max"}\NormalTok{)}

\NormalTok{log_fold_change_min =}\StringTok{ }\KeywordTok{estimate_log_fold_change}\NormalTok{(}
\NormalTok{    moanin_model, timecourse_contrasts, }\DataTypeTok{method=}\StringTok{"min"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The returning object is a matrix, where each row corresponds to a gene,
each column to a contrasts, and each entry to the log-fold change for this
pair of contrast and gene.

\begin{longtable}[]{@{}ccccc@{}}
\toprule
\begin{minipage}[b]{0.30\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
M-K\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
M-C\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
M-VL\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
M-VH\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.30\columnwidth}\centering
\textbf{NM\_009912}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.4091\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.7525\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-1.025\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-1.42\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.30\columnwidth}\centering
\textbf{NM\_008725}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
1.575\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
2.008\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
2.543\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
2.618\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.30\columnwidth}\centering
\textbf{NM\_007473}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.4158\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.3346\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.2127\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.3643\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.30\columnwidth}\centering
\textbf{ENSMUST00000094955}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.1126\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.3763\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.1558\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.3091\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.30\columnwidth}\centering
\textbf{NM\_001042489}\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.2341\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
-0.4104\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.3085\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.4301\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

In Figure \ref{fig:compareLogFoldChange} we plot the log-fold change summary of each of these methods against each other. We see that each methods captures different elements of
the time-course data, for example, overall change versus the largest change.

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/compareLogFoldChange-1} 

}

\caption{Comparison of the different methods of calculating log-fold change per gene}\label{fig:compareLogFoldChange}
\end{figure}

With a single measure of log-fold change and the p-value, we can now look
at the traditional volcano plot. In Figure \ref{fig:volcano}, we show the example of a volcano plot for the comparaison
of the control to the Kawasaki strain, using the ``timecourse'' method of calculating log fold change.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pvalue =}\StringTok{ }\NormalTok{DE_results[, }\StringTok{"M-K_pval"}\NormalTok{]}
\KeywordTok{names}\NormalTok{(pvalue) =}\StringTok{ }\KeywordTok{row.names}\NormalTok{(DE_results)}
\NormalTok{lfc_timecourse =}\StringTok{ }\NormalTok{log_fold_change_timecourse[, }\StringTok{"M-K"}\NormalTok{]}
\KeywordTok{names}\NormalTok{(lfc_timecourse) =}\StringTok{ }\KeywordTok{row.names}\NormalTok{(log_fold_change_timecourse)}

\KeywordTok{plot}\NormalTok{(lfc_timecourse, }\OperatorTok{-}\KeywordTok{log10}\NormalTok{(pvalue), }\DataTypeTok{pch=}\DecValTok{20}\NormalTok{, }\DataTypeTok{main=}\StringTok{"Volcano plot"}\NormalTok{,}
     \DataTypeTok{xlim=}\KeywordTok{c}\NormalTok{(}\OperatorTok{-}\FloatTok{2.5}\NormalTok{, }\DecValTok{2}\NormalTok{), }\DataTypeTok{xlab=}\StringTok{"Timecourse lfc"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/volcano-1} 

}

\caption{Volcano plot for the comparison of the Kawasaki strain to control, where fold-change is calculated with the timecourse method}\label{fig:volcano}
\end{figure}

\hypertarget{visualizing-genes-of-interest}{%
\subsubsection{Visualizing Genes of Interest}\label{visualizing-genes-of-interest}}

The package \texttt{moanin} also provides a simple utility function (\texttt{plot\_splines\_data}) to
visualize gene time-course data from different conditions. In Figure \ref{fig:topPvalueGenes}, we plot the 10
genes with the smallest p-values.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{top_DE_genes_pval =}\StringTok{ }\KeywordTok{names}\NormalTok{(}\KeywordTok{sort}\NormalTok{(pvalue)[}\DecValTok{1}\OperatorTok{:}\DecValTok{10}\NormalTok{])}
\KeywordTok{plot_splines_data}\NormalTok{(moanin_model,}\DataTypeTok{subset_data=}\NormalTok{top_DE_genes_pval, }
    \DataTypeTok{colors=}\NormalTok{ann_colors}\OperatorTok{$}\NormalTok{Group, }\DataTypeTok{smooth=}\OtherTok{TRUE}\NormalTok{,}
    \DataTypeTok{mar=}\KeywordTok{c}\NormalTok{(}\FloatTok{1.5}\NormalTok{,}\FloatTok{2.5}\NormalTok{,}\DecValTok{2}\NormalTok{,}\FloatTok{0.1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/topPvalueGenes-1} 

}

\caption{Top 10 genes with the smallest p-values}\label{fig:topPvalueGenes}
\end{figure}

For each gene, the individual data points are plotted against time and color coded by their condition. Further, a fitted spline function for each group is plotted to aid in comparing global trends across conditions.

Figure \ref{fig:topLogFold}, we visualize the genes with the largest absolute timecourse log-fold
change.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{top_DE_genes_lfc =}\StringTok{ }\KeywordTok{names}\NormalTok{(}
    \KeywordTok{sort}\NormalTok{(}\KeywordTok{abs}\NormalTok{(lfc_timecourse),}
     \DataTypeTok{decreasing=}\OtherTok{TRUE}\NormalTok{)[}\DecValTok{1}\OperatorTok{:}\DecValTok{10}\NormalTok{])}
\KeywordTok{plot_splines_data}\NormalTok{(moanin_model, }\DataTypeTok{subset_data=}\NormalTok{top_DE_genes_lfc, }
    \DataTypeTok{colors=}\NormalTok{ann_colors}\OperatorTok{$}\NormalTok{Group, }\DataTypeTok{smooth=}\OtherTok{TRUE}\NormalTok{,}
    \DataTypeTok{mar=}\KeywordTok{c}\NormalTok{(}\FloatTok{1.5}\NormalTok{,}\FloatTok{2.5}\NormalTok{,}\DecValTok{2}\NormalTok{,}\FloatTok{0.1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/topLogFold-1} 

}

\caption{Top 10 genes with largest absolute timecourse log-fold change}\label{fig:topLogFold}
\end{figure}

In examining these visualizations, we can see that genes often follow similar
patterns of expression, although on a different scale for each gene. We can
leverage this observation to cluster the genes into groups of similar patterns
of transcriptomic response.

\hypertarget{clustering-of-time-course-data}{%
\subsection{Clustering of time-course data}\label{clustering-of-time-course-data}}

The very large number of genes found differentially expressed impair any
interpretation one would attempt: with 70\% of the genome found differentially
expressed, all pathways are affected by the treatment. Hence the next step of
the workflow to cluster gene expression according to their dynamical response
to the treatment.

\textbf{Filtering} Before clustering the genes, we first reduce the set of
genes of interest to genes that are (1) found significantly differentially
expressed; (2) a large-fold change between conditions. Reducing the set of genes on which to perform the clustering allows to
estimate the centroids of the clusters with more stability.

To do this, we first
aggregate all p-values obtained during the time-course differential expresison
step in a single p-value using Fisher's method \citep{fisher:statistical} (\texttt{pvalues\_fisher\_method}).
Next we
select all the genes which have a Fisher-adjusted p-value below 0.05 and a log-fold
change of at least two for at least one condition and one time-point.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Then rank by fisher's p-value and take max the number of genes of interest}
\CommentTok{# Filter out q-values for the pvalues table}
\NormalTok{fishers_pval =}\StringTok{ }\KeywordTok{pvalues_fisher_method}\NormalTok{(pvalues)}
\NormalTok{qvalues =}\StringTok{ }\KeywordTok{apply}\NormalTok{(pvalues, }\DecValTok{2}\NormalTok{, p.adjust)}
\NormalTok{fishers_qval =}\StringTok{ }\KeywordTok{p.adjust}\NormalTok{(fishers_pval)}

\NormalTok{genes_to_keep =}\StringTok{ }\KeywordTok{row.names}\NormalTok{(}
\NormalTok{    log_fold_change_max[}
\NormalTok{    (}\KeywordTok{rowSums}\NormalTok{(log_fold_change_max }\OperatorTok{>}\StringTok{ }\DecValTok{2}\NormalTok{) }\OperatorTok{>}\StringTok{ }\DecValTok{0}\NormalTok{) }\OperatorTok{&}
\StringTok{    }\NormalTok{(fishers_qval }\OperatorTok{<}\StringTok{ }\FloatTok{0.05}\NormalTok{), ])}
\CommentTok{# Keep the data corresponding to the genes of interest in another variable.}
\CommentTok{# by subsetting the `moanin_model`, which contains the data.}
\NormalTok{de_moanin_model =}\StringTok{ }\NormalTok{moanin_model[genes_to_keep,]}
\end{Highlighting}
\end{Shaded}

\hypertarget{clustering-based-on-spline-fits}{%
\subsubsection{Clustering Based on Spline Fits}\label{clustering-based-on-spline-fits}}

After filtering, we are left with 5521 genes. We can then apply a
clustering routine. As observed by looking at genes found differentially expressed,
many genes share a similar gene expression pattern, but on different scale.

We thus propose the following adaptation of k-means:

\begin{itemize}
\tightlist
\item
  \textbf{Splines estimation}: for each gene, fit the splines function with the basis
  of your choice (as contained in the \texttt{Moanin} object).
\item
  \textbf{Rescaling splines}: for each gene, rescale the estimated splines function
  such that the values are bounded between 0 and 1 and thus comparable between genes.
\item
  \textbf{K-means}: apply k-means on the rescaled fitted values of the splines to estimate the
  cluster centroids.
\end{itemize}

The rescaling of the splines is similar to the rescaling genes by their standard deviation, which is common for gene expression studies without a time component.

These clustering steps are performed by the \texttt{splines\_kmeans}
function in \texttt{moanin}. For now, we will set the number of clusters to be \(8\), though we
will return to the question of picking the best number of clusters below.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# First fit the kmeans clusters}
\NormalTok{kmeans_clusters =}\StringTok{ }\KeywordTok{splines_kmeans}\NormalTok{(de_moanin_model, }\DataTypeTok{n_clusters=}\DecValTok{8}\NormalTok{,}
    \DataTypeTok{random_seed=}\DecValTok{42}\NormalTok{,}
    \DataTypeTok{n_init=}\DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The \texttt{splines\_kmeans} function returns a named list with:

\begin{itemize}
\tightlist
\item
  \texttt{centroids}: a matrix containing the cluster centroids. The matrix is of
  shape (\texttt{n\_centroid}, \texttt{n\_samples}).
\item
  \texttt{clusters}: a vector of size \texttt{n\_genes}, containing the cluster assignments given by the \texttt{kmeans} step of each gene
\end{itemize}

We then use the \texttt{plot\_splines\_data} function, only now applied to the
centroids, to visualize the centroids of each cluster obtained with the
splines k-means model (Figure \ref{fig:centroids}).

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{plot_splines_data}\NormalTok{(de_moanin_model,}
    \DataTypeTok{data=}\NormalTok{kmeans_clusters}\OperatorTok{$}\NormalTok{centroids, }
    \DataTypeTok{colors=}\NormalTok{ann_colors}\OperatorTok{$}\NormalTok{Group,}
    \DataTypeTok{smooth=}\OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/centroids-1} 

}

\caption{K-means centroids}\label{fig:centroids}
\end{figure}

These centroids are on a 0-1 scale, because of our rescaling of the spline
fits, and do not represent the actual gene expression level. In Figure \ref{fig:genesVsCentroids}, we plot a few
of the actual genes assigned to cluster 2 with the estimated centroid overlaid:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cluster_of_interest =}\StringTok{ }\DecValTok{2}
\NormalTok{cluster2Genes =}\StringTok{ }\KeywordTok{names}\NormalTok{(}
\NormalTok{    kmeans_clusters}\OperatorTok{$}\NormalTok{clusters[kmeans_clusters}\OperatorTok{$}\NormalTok{clusters}\OperatorTok{==}\NormalTok{cluster_of_interest])}
\KeywordTok{plot_splines_data}\NormalTok{(de_moanin_model,  }
    \DataTypeTok{centroid=}\NormalTok{kmeans_clusters}\OperatorTok{$}\NormalTok{centroids[cluster_of_interest,], }
    \DataTypeTok{colors=}\NormalTok{ann_colors}\OperatorTok{$}\NormalTok{Group, }\DataTypeTok{smooth=}\OtherTok{TRUE}\NormalTok{,}\DataTypeTok{simpleY =}\OtherTok{FALSE}\NormalTok{,}
    \DataTypeTok{subset_data=}\NormalTok{cluster2Genes[}\DecValTok{3}\OperatorTok{:}\DecValTok{6}\NormalTok{],}
    \DataTypeTok{mar=}\KeywordTok{c}\NormalTok{(}\FloatTok{1.5}\NormalTok{,}\FloatTok{2.5}\NormalTok{,}\DecValTok{2}\NormalTok{,}\FloatTok{0.1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/genesVsCentroids-1} 

}

\caption{Genes from cluster 2}\label{fig:genesVsCentroids}
\end{figure}

\hypertarget{assigning-genes-to-clusters}{%
\subsubsection{Assigning genes to clusters}\label{assigning-genes-to-clusters}}

As we can see, while these genes have some similarity with the pattern of the cluster centroids, these particularly genes are not the best examples of the cluster, in the sense of matching the centroid estimates. Because of this variability in how well the genes fit a cluster, we would like to be able to score how well a gene fits a cluster.

Furthermore, we arbitrarily chose a subset of genes based on our filter, and we would
like to have a mechanism to assign all genes to a cluster.

Thus, the next step in the clustering portion of the workflow is a scoring and label step. Each gene is given a score that
corresponds to a goodness-of-fit between each gene and each cluster, computed
as follows:

\[
S(y_i, \mu_k) =  \frac{1}{S_0(k)} \times \underset{a_{iG_j}, b_{iG_j}}{\text{min}}\sum_{j}
  {\left(b_{iG_j}y_{ij} + a_{iG_j}
   - \mu_k(t_j)\right)}^2 \,,
\]

where \(\mu_k\) is the centroid of cluster \(k\) and \(y_i\) the gene of interest.
The scoring function thus returns a value between 0 and 1, 0 being the best
score possible and 1 the worst score possible (no correlation between the gene
and the cluster centroid).

The score then allows us to assign all genes to a cluster (i.e.~a label) based on the cluster for which they have the best score, regardless of whether the gene was used in the clustering procedure.

The scoring and labeling is done via the \texttt{splines\_kmeans\_score\_and\_label}
function. This function calculates the goodness of fit of the gene to the
cluster centroid and gives a cluster label to the gene if they have a sufficiently high score, as we explain above.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Then assign scores and labels to *all* the data, using a goodness-of-fit}
\CommentTok{# scoring function.}
\NormalTok{scores_and_labels =}\StringTok{ }\KeywordTok{splines_kmeans_score_and_label}\NormalTok{(}
\NormalTok{    moanin_model, kmeans_clusters)}
\end{Highlighting}
\end{Shaded}

The \texttt{scores\_and\_labels} list contains three elements:

\begin{itemize}
\tightlist
\item
  \texttt{scores}: the matrix of shape \texttt{n\_cluster} x \texttt{n\_genes},
  containing for each gene and each cluster, the goodness of fit as
  described above.
\item
  \texttt{labels}: the labels for all of the genes with a
  sufficiently good goodness-of-fit score.
\item
  \texttt{score\_cutoff}: the cutoff used on \texttt{scores} to determine whether to
  assign a label
\end{itemize}

\textbf{Assigning cluster labels:} We could just assign each gene to a cluster
based on which cluster gave the minimum score. By default,
\texttt{splines\_kmeans\_score\_and\_label} does not do that, but rather requires a
sufficiently low enough goodness-of-fit score. The criteria for being
``sufficiently low'' is based on looking at the distribution of the scores of
all genes on all clusters (i.e.~the entire \texttt{scores} matrix returned by
\texttt{splines\_kmeans\_score\_and\_label}). A gene is then assigned to a cluster only
if their best score is above the 50\% percentile of that distribution, with the
remaining genes getting \texttt{NA} as their assignment (this choice can be changed
by \texttt{proportion\_genes\_to\_label}). Note that because the distribution of scores
of genes across \emph{all} clusters are used, this is not equivalent to assigning
50\% of genes to a cluster -- it is possible that all genes are assigned to a
cluster.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{labels =}\StringTok{ }\NormalTok{scores_and_labels}\OperatorTok{$}\NormalTok{labels}

\CommentTok{# Let's keep only the list of genes that have a label.}
\NormalTok{labels =}\StringTok{ }\KeywordTok{unlist}\NormalTok{(labels[}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(labels)])}

\CommentTok{# And also keep track of all the genes in cluster 2.}
\NormalTok{genes_in_cluster2 =}\StringTok{ }\KeywordTok{names}\NormalTok{(labels[labels}\OperatorTok{==}\NormalTok{cluster_of_interest])}
\end{Highlighting}
\end{Shaded}

After running \texttt{scores\_and\_labels} on our data, we now have 19772 genes that
are assigned to a cluster.

We can visualize the impact of this filtering process by considering the
distribution of goodness-of-fit scores for each cluster if we did not have the
filtering cutoff of \texttt{splines\_kmeans\_score\_and\_label}, i.e.~if we simply assign
every gene to a cluster based on which gives them their minimum score. We
display for each cluster, the scores of the genes assigned to that cluster
(Figure \ref{fig:visualizeScores}), as compared to the cutoff value for what
that score must be under our filtering procedure. We can do this by rerunning
\texttt{splines\_kmeans\_score\_and\_label} and setting the filter
\texttt{percentage\_genes\_to\_label=1} (and we can speed up the calculation by giving
our previously calculated score via the argument \texttt{previous\_scores})

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Get the best score and best label for all of the genes}
\CommentTok{# This time without filtering labels}
\CommentTok{# We can give the previous calculated scores to `previous_scores` to save time}
\NormalTok{unfiltered_scores =}\StringTok{ }\KeywordTok{splines_kmeans_score_and_label}\NormalTok{(}
\NormalTok{    moanin_model, kmeans_clusters,}
    \DataTypeTok{proportion_genes_to_label=}\DecValTok{1}\NormalTok{,}
    \DataTypeTok{previous_scores=}\NormalTok{scores_and_labels}\OperatorTok{$}\NormalTok{scores)}
\NormalTok{best_score =}\StringTok{ }\KeywordTok{rowMin}\NormalTok{(scores_and_labels}\OperatorTok{$}\NormalTok{scores)}
\NormalTok{best_label =}\StringTok{ }\NormalTok{unfiltered_scores}\OperatorTok{$}\NormalTok{labels}

\KeywordTok{par}\NormalTok{(}\DataTypeTok{mfrow=}\KeywordTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{))}
\NormalTok{n_clusters =}\StringTok{ }\KeywordTok{dim}\NormalTok{(kmeans_clusters}\OperatorTok{$}\NormalTok{centroids)[}\DecValTok{1}\NormalTok{]}
\ControlFlowTok{for}\NormalTok{(cluster_id }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{n_clusters)\{}
    \KeywordTok{hist}\NormalTok{(best_score[best_label}\OperatorTok{==}\NormalTok{cluster_id],}
     \DataTypeTok{breaks=}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{50}\OperatorTok{/}\DecValTok{50}\NormalTok{), }\DataTypeTok{xlim=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{),}
     \DataTypeTok{col=}\StringTok{"black"}\NormalTok{, }\DataTypeTok{main=}\KeywordTok{paste}\NormalTok{(}\StringTok{"C"}\NormalTok{, cluster_id, }\DataTypeTok{sep=}\StringTok{""}\NormalTok{),}
     \DataTypeTok{xlab=}\StringTok{"score"}\NormalTok{, }\DataTypeTok{ylab=}\StringTok{"Num. genes"}\NormalTok{)}
    \KeywordTok{abline}\NormalTok{(}\DataTypeTok{v=}\NormalTok{scores_and_labels}\OperatorTok{$}\NormalTok{score_cutoff, }\DataTypeTok{col=}\StringTok{"red"}\NormalTok{, }\DataTypeTok{lwd=}\DecValTok{3}\NormalTok{, }\DataTypeTok{lty=}\DecValTok{2}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/visualizeScores-1} 

}

\caption{Distribution of goodness-of-fit scores for each cluster. The dashed red line indicates the scoring threshold: all genes with a score above this threshold will not be labeled.}\label{fig:visualizeScores}
\end{figure}

Note that for some of the genes, their scores in all clusters is 1. Such genes fit
poorly to all clusters and the assignment we did above to one cluster is done arbitrarily to the first matching cluster.
This underlines the importance of filtering genes that fit poorly to clusters.

We can also investigate the
differences between the labels provided by the splines k-means model and our
scoring and labeling step, in terms of the number of genes assigned to each cluster (Figure \ref{fig:kmeansVsScore}).

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/kmeansVsScore-1} 

}

\caption{Number of genes assigned to each cluster based on kmeans criteria of nearest centroid (top) versus our goodness-of-fit filtering strategy (bottom)}\label{fig:kmeansVsScore}
\end{figure}

Of the original 5521 genes used in the
clustering, 4946 are still assigned to a cluster based on their goodness of
fit score. We can compare whether they are still assigned to the same clusters
based on a confusion matrix shown below (Figure \ref{fig:confusionMatrix}). The kmeans cluster assignments are
shown on the rows, and the goodness-of-fit assignments in the columns, with
the number in each cell indicating the number of genes in the intersection of
the two clusters.

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/confusionMatrix-1} 

}

\caption{Confusion matrix between the two sets of labels}\label{fig:confusionMatrix}
\end{figure}

Of the four genes we plotted before, 2 of them remained assigned to cluster 2 after our scoring. We can again look at a
few genes in cluster 2, only now pick the best scoring genes (Figure \ref{fig:topScoreInCluster2})

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# order them by their score in cluster}
\NormalTok{ord =}\StringTok{ }\KeywordTok{order}\NormalTok{(scores_and_labels}\OperatorTok{$}\NormalTok{scores[genes_in_cluster2,}
\NormalTok{                     cluster_of_interest])}
\NormalTok{cluster2Score =}\StringTok{ }\NormalTok{genes_in_cluster2[ord]}
\KeywordTok{plot_splines_data}\NormalTok{(}
\NormalTok{    moanin_model, }\DataTypeTok{subset_data=}\NormalTok{cluster2Score[}\DecValTok{1}\OperatorTok{:}\DecValTok{4}\NormalTok{], }
    \DataTypeTok{centroid=}\NormalTok{kmeans_clusters}\OperatorTok{$}\NormalTok{centroids[cluster_of_interest,], }
    \DataTypeTok{colors=}\NormalTok{ann_colors}\OperatorTok{$}\NormalTok{Group, }\DataTypeTok{smooth=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{simpleY=}\OtherTok{FALSE}\NormalTok{,}
    \DataTypeTok{mar=}\KeywordTok{c}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\FloatTok{2.5}\NormalTok{, }\DecValTok{2}\NormalTok{, }\FloatTok{0.1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/topScoreInCluster2-1} 

}

\caption{Top scoring genes in Cluster 2}\label{fig:topScoreInCluster2}
\end{figure}

We see that, as expected, these genes are a much better match to the cluster centroids.

\hypertarget{looking-at-specific-clusters-in-details.}{%
\subsubsection{Looking at specific clusters in details.}\label{looking-at-specific-clusters-in-details.}}

Now, let us look more in detail some specific clusters. Cluster 6 seems
particularly interesting: it captures genes with strong differences between
the different influenza treatments and the control, while the control remains
relatively flat.

We've already shown how we can plot a few example genes, however, it can be
hard to make sense of individual genes given the amount of noise, as well as
being hard to draw conclusions based on a few genes.

Heatmaps are useful to investigate the range of expression patterns for
specific genes. Here, we are going to plot heatmaps of the normalized gene
expression patterns and the rescaled gene expression patterns side by side.

First, we select the genes of interest, namely those in cluster 6, based on
our goodness-of-fit assignment.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cluster_to_plot =}\StringTok{ }\DecValTok{6}
\NormalTok{genes_to_plot =}\StringTok{  }\KeywordTok{names}\NormalTok{(labels[labels }\OperatorTok{==}\StringTok{ }\NormalTok{cluster_to_plot])}
\end{Highlighting}
\end{Shaded}

Now we will create the heatmaps of these genes (3746 genes, Figure \ref{fig:heatmapCluster8}).

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{layout}\NormalTok{(}\KeywordTok{matrix}\NormalTok{(}\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{),}\DataTypeTok{nrow=}\DecValTok{1}\NormalTok{), }\DataTypeTok{widths=}\KeywordTok{c}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\DecValTok{2}\NormalTok{))}

\CommentTok{# order the observations by Group, then time, then replicate}
\NormalTok{orderedMeta<-}\KeywordTok{data.frame}\NormalTok{(}\KeywordTok{colData}\NormalTok{(moanin_model))}
\NormalTok{ord =}\StringTok{ }\KeywordTok{order}\NormalTok{(}
\NormalTok{  orderedMeta}\OperatorTok{$}\NormalTok{Group,}
\NormalTok{  orderedMeta}\OperatorTok{$}\NormalTok{Timepoint,}
\NormalTok{  orderedMeta}\OperatorTok{$}\NormalTok{Replicate)}
\NormalTok{orderedMeta}\OperatorTok{$}\NormalTok{Timepoint =}\StringTok{ }\KeywordTok{as.factor}\NormalTok{(orderedMeta}\OperatorTok{$}\NormalTok{Timepoint)}

\NormalTok{orderedMeta =}\StringTok{ }\NormalTok{orderedMeta[ord, ]}

\NormalTok{res =}\StringTok{ }\KeywordTok{aheatmap}\NormalTok{(}
    \KeywordTok{as.matrix}\NormalTok{(}\KeywordTok{assay}\NormalTok{(moanin_model[genes_to_plot,ord])),}
    \DataTypeTok{Colv=}\OtherTok{NA}\NormalTok{,}
    \DataTypeTok{color=}\StringTok{"YlGnBu"}\NormalTok{,}
    \DataTypeTok{annCol=}\NormalTok{orderedMeta[,}\KeywordTok{c}\NormalTok{(}\StringTok{"Group"}\NormalTok{, }\StringTok{"Timepoint"}\NormalTok{)],}
    \DataTypeTok{annLegend=}\OtherTok{FALSE}\NormalTok{,}
    \DataTypeTok{annColors=}\NormalTok{ann_colors,}
    \DataTypeTok{main=}\KeywordTok{paste}\NormalTok{(}\StringTok{"Cluster"}\NormalTok{, cluster_to_plot, }\StringTok{"(raw)"}\NormalTok{),}
    \DataTypeTok{treeheight=}\DecValTok{0}\NormalTok{, }\DataTypeTok{legend=}\OtherTok{FALSE}\NormalTok{)}

\CommentTok{# Now use the results of the previous call to aheatmap to reorder the genes.}
\KeywordTok{aheatmap}\NormalTok{(}
    \KeywordTok{rescale_values}\NormalTok{(moanin_model[genes_to_plot,ord])[res}\OperatorTok{$}\NormalTok{rowInd,],}
    \DataTypeTok{Colv=}\OtherTok{NA}\NormalTok{,}
    \DataTypeTok{Rowv=}\OtherTok{NA}\NormalTok{,}
    \DataTypeTok{annCol=}\NormalTok{orderedMeta[, }\KeywordTok{c}\NormalTok{(}\StringTok{"Group"}\NormalTok{, }\StringTok{"Timepoint"}\NormalTok{)],}
    \DataTypeTok{annLegend=}\OtherTok{TRUE}\NormalTok{,}
    \DataTypeTok{annColors=}\NormalTok{ann_colors,}
    \DataTypeTok{main=}\KeywordTok{paste}\NormalTok{(}\StringTok{"Cluster"}\NormalTok{, cluster_to_plot, }\StringTok{"(rescaled)"}\NormalTok{),}
    \DataTypeTok{treeheight=}\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/heatmapCluster8-1} 

}

\caption{Heatmap of genes in Cluster 6}\label{fig:heatmapCluster8}
\end{figure}

Those two heatmaps demonstrate that the clustering method successfully cluster
genes that are on different scales, and yet share the same dynamical response
to the treatments.

\hypertarget{how-to-choose-the-number-of-clusters.}{%
\subsubsection{How to choose the number of clusters.}\label{how-to-choose-the-number-of-clusters.}}

A common question that arises when performing clustering is how to choose the
number of clusters. A choice for the number of clusters K depends on the goal.
In this particular case, the end goal is not the clustering, but to facilitate
interpretation of the differential expression analysis step. As a result, the
number of clusters should not exceed the number of gene sets the user wants to
interpret. This allows to set a maximum number of clusters. Let us assume here
that this number is 20 clusters.

Once the maximum number of clusters is set, several strategies allow to
identify the number of clusters:

\begin{itemize}
\tightlist
\item
  \textbf{Elbow method}. First introduced in 1953 by Thorndike \citep{thorndike:who},
  the elbow methods looks at the total within cluster sum of squares
  as a function of the number of clusters (WCSS). When adding clusters
  doesn't decrease the WCSS by a sufficient
  amount, one can consider stopping. This method thus provides visual aid to
  the user to choose the number of clusters, but often the ``elbow'' is hard to
  see on real data, where the number of clusters is not clearly defined.
\item
  \textbf{Silhouette method}. Similarly to the Elbow method, the Silhouette method
  refers to a method of validation of consistency within clusters, and
  provides visual aid to choose the number of clusters.
\item
  \textbf{Stability methods} Stability methods are more computationally intensive
  than any other method, as they rely on assessing the stability of the
  clustering for every \(k\) to a small randomization of the data. The user is
  then invited to choose the number of cluster based on a number of similarity
  measures.
\end{itemize}

First, let us run the clustering for all values of \(k\) of interest. We
will, for each clustering, conserve (1) with within cluster sum of
squares; (2) the clustering assignement (or label) for each gene.

Below we run the clustering for \(k\) equal to \(2-20\). The \texttt{splines\_kmeans}
function returns the WCSS for each cluster, which we sum to get the total
WCSS.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{all_possible_n_clusters =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2}\OperatorTok{:}\DecValTok{20}\NormalTok{)}
\NormalTok{all_clustering =}\StringTok{ }\KeywordTok{list}\NormalTok{()}
\NormalTok{wss_values =}\StringTok{ }\KeywordTok{list}\NormalTok{()}

\NormalTok{i =}\StringTok{ }\DecValTok{1}
\ControlFlowTok{for}\NormalTok{(n_cluster }\ControlFlowTok{in}\NormalTok{ all_possible_n_clusters)\{}
\NormalTok{    clustering_results =}\StringTok{ }\KeywordTok{splines_kmeans}\NormalTok{(de_moanin_model,}
    \DataTypeTok{n_clusters=}\NormalTok{n_cluster, }\DataTypeTok{random_seed=}\DecValTok{42}\NormalTok{,}
    \DataTypeTok{n_init=}\DecValTok{10}\NormalTok{)}
\NormalTok{    wss_values[i] =}\StringTok{ }\KeywordTok{sum}\NormalTok{(clustering_results}\OperatorTok{$}\NormalTok{WCSS_per_cluster)}
\NormalTok{    all_clustering[[i]] =}\StringTok{ }\NormalTok{clustering_results}\OperatorTok{$}\NormalTok{clusters}
\NormalTok{    i =}\StringTok{ }\NormalTok{i }\OperatorTok{+}\StringTok{ }\DecValTok{1}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{elbow-method}{%
\paragraph{Elbow method}\label{elbow-method}}

The Elbow method to choose the number of clusters relies on visualization aid
to choose the number of clusters. The method relies on plotting the within
cluster sum of squares (WCSS) as a function of the number of clusters. At some
point, the WCSS will start decreasing more slowly, giving an angle or ``elbow''
in the graph. The number of cluster is chosen at this ``Elbow point.''

We plot the WCSS for \(k=2-20\) here (Figure \ref{fig:elbowMethod}).
We see that as expected the WCSS continues
to drop, but there is no clear drop in the decrease, except for very small
values of \(k\) (3-4 clusters). However, 3-4 seems a very small number of gene
clusters to find, given the complexity

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{plot}\NormalTok{(all_possible_n_clusters, wss_values,}
     \DataTypeTok{type=}\StringTok{"b"}\NormalTok{, }\DataTypeTok{pch=}\DecValTok{19}\NormalTok{, }\DataTypeTok{frame=}\OtherTok{FALSE}\NormalTok{, }
     \DataTypeTok{xlab=}\StringTok{"Number of clusters K"}\NormalTok{,}
     \DataTypeTok{ylab=}\StringTok{"Total within-clusters sum of squares"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/elbowMethod-1} 

}

\caption{Plot of WCSS as a function of k}\label{fig:elbowMethod}
\end{figure}

\hypertarget{average-silhouette-method}{%
\paragraph{Average silhouette method}\label{average-silhouette-method}}

The silhouette value is a measure of how similar a data point is to its own
cluster (cohesion) compared to other clusters (separation), shown in Figure \ref{fig:averageSilhouetteMethod}.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# function to compute average silhouette for k clusters}
\NormalTok{average_silhouette =}\StringTok{ }\ControlFlowTok{function}\NormalTok{(labels, y) \{}
\NormalTok{    silhouette_results =}\StringTok{ }\KeywordTok{silhouette}\NormalTok{(}\KeywordTok{unlist}\NormalTok{(labels[}\DecValTok{1}\NormalTok{]),}\KeywordTok{dist}\NormalTok{(y))}
    \KeywordTok{return}\NormalTok{(}\KeywordTok{mean}\NormalTok{(silhouette_results[, }\DecValTok{3}\NormalTok{]))}
\NormalTok{\}}

\CommentTok{# extract the average silhouette}
\NormalTok{average_silhouette_values =}\StringTok{ }\KeywordTok{list}\NormalTok{()}
\NormalTok{i =}\StringTok{ }\DecValTok{1}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(all_clustering))\{}
\NormalTok{    clustering_results =}\StringTok{ }\NormalTok{all_clustering[i]}
\NormalTok{    average_silhouette_values[i] =}\StringTok{ }\KeywordTok{average_silhouette}\NormalTok{(clustering_results,}
        \KeywordTok{assay}\NormalTok{(de_moanin_model))}
\NormalTok{    i =}\StringTok{ }\NormalTok{i }\OperatorTok{+}\StringTok{ }\DecValTok{1}
\NormalTok{\}}

\KeywordTok{plot}\NormalTok{(all_possible_n_clusters, average_silhouette_values,}
     \DataTypeTok{type=}\StringTok{"b"}\NormalTok{, }\DataTypeTok{pch=}\DecValTok{19}\NormalTok{, }\DataTypeTok{frame=}\OtherTok{FALSE}\NormalTok{,}
     \DataTypeTok{xlab=}\StringTok{"Number of clusters K"}\NormalTok{,}
     \DataTypeTok{ylab=}\StringTok{"Average Silhouettes"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/averageSilhouetteMethod-1} 

}

\caption{Plot of silhouette values as a function of k}\label{fig:averageSilhouetteMethod}
\end{figure}

\hypertarget{looking-at-the-stability-of-the-clustering}{%
\paragraph{Looking at the stability of the clustering}\label{looking-at-the-stability-of-the-clustering}}

On real data, the number of clusters is not only unknown but also
ambiguous: it will depend on the desired clustering resolution of the user.
Yet, in the case of biological data, stability and reproducibility of the
results is necessary to ensure that the biological interpretation of the
results hold when the data or the model is exposed to reasonable
perturbations.

Methods that rely on the stability of the clustering results to choose \(k\)
thus ensure that the biological interpretation of the clusters hold with
perturbtation to the data. In addition, simulation where the data is generated
with a well defined \(k\) show that the clustering is more stable for the
correct of number of the clusters.

Most methods method to find the number of clusters with stability measures
only provide visual aids to guide the user. The first element often visualized
is the consensus matrix: the consensus matrix is an \(n \times n\) matrix that
stores the proportion of clustering in which two items are clustered together.
A perfect consensus matrix ordered such as each elements that belong to the
same cluster are adjacent to one another which show blocks along the diagonal
close to 1.

To perform such analysis, the first step is run the clustering several times
on a resampled dataset--either using bootstrap or subsampling.

Using the bootstrapping strategy, we sample with replacement a sample of the
same size as our original clustering (i.e.~5521 genes):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n_genes =}\StringTok{ }\KeywordTok{dim}\NormalTok{(de_moanin_model)[}\DecValTok{1}\NormalTok{]}
\NormalTok{indices =}\StringTok{ }\KeywordTok{sample}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(de_moanin_model)[}\DecValTok{1}\NormalTok{], n_genes, }\DataTypeTok{replace=}\OtherTok{TRUE}\NormalTok{)}

\NormalTok{bootstrapped_y =}\StringTok{ }\NormalTok{de_moanin_model[indices, ]}
\end{Highlighting}
\end{Shaded}

Using the subsampling strategy, we take a unique subset of the genes, keeping 80\% of the genes:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{subsample_proportion =}\StringTok{ }\FloatTok{0.8}
\NormalTok{indices =}\StringTok{ }\KeywordTok{sample}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(de_moanin_model)[}\DecValTok{1}\NormalTok{],}
\NormalTok{         n_genes }\OperatorTok{*}\StringTok{ }\NormalTok{subsample_proportion,}
         \DataTypeTok{replace=}\OtherTok{FALSE}\NormalTok{)}

\NormalTok{subsampled_y =}\StringTok{ }\NormalTok{de_moanin_model[indices, ]}
\end{Highlighting}
\end{Shaded}

We run the bootstrap method on all genes differentially expressed and with a
log-fold-change higher than 2 (computed with the \texttt{lfc\_max} method), and do it
\(B=20\) times for each of \(k=2-20\). We show the code below, but because of the
time the computations take, we have evaluate these values separately and provided the
results in separate files (one per \(k\)) for users to explore more quickly.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# You may want to set the random seed of the experiment so that the results}
\CommentTok{# don't vary if you rerun the experiment.}
\CommentTok{# set.seed(random_seed)}
\NormalTok{n_genes =}\StringTok{ }\KeywordTok{dim}\NormalTok{(de_moanin_model)[}\DecValTok{1}\NormalTok{] }\OperatorTok{*}\StringTok{ }\NormalTok{subsample_proportion}
\NormalTok{indices =}\StringTok{ }\KeywordTok{sample}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(de_moanin_model)[}\DecValTok{1}\NormalTok{], n_genes, }\DataTypeTok{replace=}\OtherTok{TRUE}\NormalTok{)}

\NormalTok{kmeans_clusters =}\StringTok{ }\KeywordTok{splines_kmeans}\NormalTok{(de_moanin_model[indices,],}
    \DataTypeTok{n_clusters=}\NormalTok{n_clusters,}
    \DataTypeTok{random_seed=}\DecValTok{42}\NormalTok{,}
    \DataTypeTok{n_init=}\DecValTok{20}\NormalTok{)}

\CommentTok{# Perform prediction on the whole set of data.}
\NormalTok{kmeans_clusters =}\StringTok{ }\KeywordTok{splines_kmeans_predict}\NormalTok{(de_moanin_model, kmeans_clusters, }
    \DataTypeTok{method=}\StringTok{"distance"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

For now, we bring in the results for \(k=5\) and \(k=20\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stability_}\DecValTok{5}\NormalTok{ =}\StringTok{ }\KeywordTok{read.table}\NormalTok{(}\StringTok{"results/stability_5.tsv"}\NormalTok{, }\DataTypeTok{sep=}\StringTok{"}\CharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{stability_}\DecValTok{20}\NormalTok{ =}\StringTok{ }\KeywordTok{read.table}\NormalTok{(}\StringTok{"results/stability_20.tsv"}\NormalTok{, }\DataTypeTok{sep=}\StringTok{"}\CharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Each column correspond to a bootstrap sample, each row to a gene, and each
entry to the label found for that particular clustering. Thus, for each gene,
we have an assignment to a cluster over the 20 resampling runs. For example,
for \(k=5\):

\begin{longtable}[]{@{}ccccccccccccc@{}}
\caption{Table continues below}\tabularnewline
\toprule
\begin{minipage}[b]{0.13\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B1\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B2\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B3\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B4\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B5\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B6\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B7\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B8\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B9\strut
\end{minipage} & \begin{minipage}[b]{0.05\columnwidth}\centering
B10\strut
\end{minipage} & \begin{minipage}[b]{0.05\columnwidth}\centering
B11\strut
\end{minipage} & \begin{minipage}[b]{0.05\columnwidth}\centering
B12\strut
\end{minipage}\tabularnewline
\midrule
\endfirsthead
\toprule
\begin{minipage}[b]{0.13\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B1\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B2\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B3\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B4\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B5\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B6\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B7\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B8\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B9\strut
\end{minipage} & \begin{minipage}[b]{0.05\columnwidth}\centering
B10\strut
\end{minipage} & \begin{minipage}[b]{0.05\columnwidth}\centering
B11\strut
\end{minipage} & \begin{minipage}[b]{0.05\columnwidth}\centering
B12\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.13\columnwidth}\centering
\textbf{AA204140}\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.05\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.05\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.05\columnwidth}\centering
3\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.13\columnwidth}\centering
\textbf{AB008911}\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
4\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.05\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.05\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.05\columnwidth}\centering
3\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.13\columnwidth}\centering
\textbf{AB010313}\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
4\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
4\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.05\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.05\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.05\columnwidth}\centering
1\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.13\columnwidth}\centering
\textbf{AB010342}\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.05\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.05\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.05\columnwidth}\centering
3\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.13\columnwidth}\centering
\textbf{AB011473}\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.05\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.05\columnwidth}\centering
4\strut
\end{minipage} & \begin{minipage}[t]{0.05\columnwidth}\centering
4\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.13\columnwidth}\centering
\textbf{AB099518}\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.05\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.05\columnwidth}\centering
4\strut
\end{minipage} & \begin{minipage}[t]{0.05\columnwidth}\centering
4\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\begin{longtable}[]{@{}cccccccccccccc@{}}
\toprule
\begin{minipage}[b]{0.11\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B13\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B14\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B15\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B16\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B17\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B18\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B19\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B20\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B21\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B22\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B23\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B24\strut
\end{minipage} & \begin{minipage}[b]{0.04\columnwidth}\centering
B25\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{AA204140}\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
4\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
4\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
4\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
4\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{AB008911}\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
4\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
4\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
4\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
4\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{AB010313}\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
4\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
4\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{AB010342}\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
4\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
4\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
3\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
4\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
4\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{AB011473}\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{AB099518}\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
5\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
2\strut
\end{minipage} & \begin{minipage}[t]{0.04\columnwidth}\centering
1\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

Now we will use the function \texttt{consensus\_matrix} in the \texttt{moanin} package to
calculate proportion of times each pair of samples was clustered together
across the 25 resampling runs, and plot the heatmap of those consensus
matrices for \(k=5\) and \(k=20\).

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{par}\NormalTok{(}\DataTypeTok{mfrow=}\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\NormalTok{consensus_matrix_stability_}\DecValTok{5}\NormalTok{ =}\StringTok{ }\KeywordTok{consensus_matrix}\NormalTok{(stability_}\DecValTok{5}\NormalTok{,}
                        \DataTypeTok{scale=}\OtherTok{FALSE}\NormalTok{)}
\KeywordTok{aheatmap}\NormalTok{(consensus_matrix_stability_}\DecValTok{5}\NormalTok{[}\DecValTok{1}\OperatorTok{:}\DecValTok{1000}\NormalTok{, }\DecValTok{1}\OperatorTok{:}\DecValTok{1000}\NormalTok{], }\DataTypeTok{Rowv=}\OtherTok{FALSE}\NormalTok{,}
     \DataTypeTok{Colv=}\OtherTok{FALSE}\NormalTok{,}
     \DataTypeTok{treeheight=}\DecValTok{0}\NormalTok{, }\DataTypeTok{main=}\StringTok{"K=5"}\NormalTok{)}

\NormalTok{consensus_matrix_stability_}\DecValTok{20}\NormalTok{ =}\StringTok{ }\KeywordTok{consensus_matrix}\NormalTok{(stability_}\DecValTok{20}\NormalTok{,}
                         \DataTypeTok{scale=}\OtherTok{FALSE}\NormalTok{)}
\KeywordTok{aheatmap}\NormalTok{(consensus_matrix_stability_}\DecValTok{20}\NormalTok{[}\DecValTok{1}\OperatorTok{:}\DecValTok{1000}\NormalTok{, }\DecValTok{1}\OperatorTok{:}\DecValTok{1000}\NormalTok{], }\DataTypeTok{Rowv=}\OtherTok{FALSE}\NormalTok{,}
     \DataTypeTok{Colv=}\OtherTok{FALSE}\NormalTok{,}
     \DataTypeTok{treeheight=}\DecValTok{0}\NormalTok{, }\DataTypeTok{main=}\StringTok{"K=20"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/bootstrapConsensus-1} 

}

\caption{Consensus matrix of proportion of times samples were in the same cluster over bootstrap samples for k=5 and 20.}\label{fig:bootstrapConsensus}
\end{figure}

We can see (Figure \ref{fig:bootstrapConsensus}) that the choice of \(K=5\) seems much more stable across resampling runs than that of \(K=20\).

\hypertarget{the-model-explorer-strategy}{%
\paragraph{The model explorer strategy}\label{the-model-explorer-strategy}}

The model explorer algorithm \citep{ben-hur:stability} proposes to estimate the
number of clusters exploiting the observation that if the number of clusters
is correct, the clustering results are stable to bootstrap resampling, as
described above. The distribution of similaries between bootstrapped results
for each \(k\) can thus be compared for different values of \(k\) and guide the
user in the choice of number of clusters.

The model explorer strategy works as follows. For a single choice of \(k\),
first perform \(n\) bootstrap experiments to estimate the cluster centroids,
followed by a step of assigning a label to all data points. Then, choose a
similarity measure between two partitions or clusters \(S(B_1, B_2)\). Examples
are the normalized mutual information or Fowlkes-Mallows. Finally, compute the
pairwise similarity measure between all bootstrapped partitions (i.e.~B choose
2 pairs). Repeat this procedure for different \(k\) and plot per \(k\) the
cumulative density of the obtained scores.

We have already run the bootstrap resampling for values \(k=2-20\) and saved the
results. We will read that data in, and use it to calculate the pairwise
similarity scores.

The function \texttt{plot\_model\_explorer} takes in input a list of the bootstrapped
results for all labels.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{plot_model_explorer}\NormalTok{(all_labels)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/plotModelExplorer-1} 

}

\caption{Plot of the cumulative density of similarity of clusterings of data for different k}\label{fig:plotModelExplorer}
\end{figure}

From this plot (Figure \ref{fig:plotModelExplorer}), we can deduce that \(k=5\)
is more stable than \(k=3\) and \(k=4\), but not as stable as \(k=2\). The model
explorer strategy, in addition to visualizing the diversity of the centroids,
can thus help assessing an adequate number of clusters.

Now, replot the same model explorer, but only for the clustering experiments
\(k=6\), \(k=7\), \(k=8\), \(k=9\) and \(k=10\) so that we can see more clearly the stability
measures in that range (Figure \ref{fig:plotModelExplorerZoom}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{clusters =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"k=6"}\NormalTok{, }\StringTok{"k=7"}\NormalTok{, }\StringTok{"k=8"}\NormalTok{, }\StringTok{"k=9"}\NormalTok{, }\StringTok{"k=10"}\NormalTok{)}
\NormalTok{selected_labels =}\StringTok{ }\NormalTok{all_labels[clusters]}
\KeywordTok{plot_model_explorer}\NormalTok{(selected_labels)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{reports/manuscript_files/figure-latex/plotModelExplorerZoom-1} 

}

\caption{Plot of the cumulative density of similarity of clusterings of data for different k, restricted to k=6-10}\label{fig:plotModelExplorerZoom}
\end{figure}

This analysis doesn't necessarily pick a particular \(k\), but can help decide
between \(k\) within a desired range, for example, or to avoid \(k\) that degrade
the stability.

\hypertarget{consensus-clustering-as-a-way-to-find-k}{%
\paragraph{\texorpdfstring{Consensus clustering as a way to find \(k\)}{Consensus clustering as a way to find k}}\label{consensus-clustering-as-a-way-to-find-k}}

The consensus clustering \citep{monti:consensus} relies on a similar idea but
instead of looking at the cumulative density of similarity measures of
bootstrapped clustering, the authors suggests plotting the cumulative density
of elements of the consensus matrix. We provide a function
\texttt{plot\_cdf\_consensus} in \texttt{moanin} to do this

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{plot_cdf_consensus}\NormalTok{(all_labels)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{images/clustering_CDF_consensus} 

}

\caption{Plot of the Consensus Clustering}\label{fig:plotCdfConsensus}
\end{figure}

The stability of the clustering based on the consensus matrix can then be
measured via a single number by looking at the area under the curve: the more
stable the clustering, the closer to 0 or 1 will be the entries of consensus
matrix. The consensus clustering strategy thus suggest at looking at either
the AUC as a function of the number of the clusters or the ``improvement'' in
the AUC as a function of the number of cluster.

Here we calculate the AUC (Figure \ref{fig:plotAUC}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{auc_scores =}\StringTok{ }\NormalTok{moanin}\OperatorTok{:::}\KeywordTok{get_auc_similarity_scores}\NormalTok{(all_labels)}
\KeywordTok{plot}\NormalTok{(n_clusters, auc_scores, }\DataTypeTok{col=}\StringTok{"black"}\NormalTok{, }\DataTypeTok{type=}\StringTok{"b"}\NormalTok{, }\DataTypeTok{pch=}\DecValTok{16}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{images/clustering_AUC_consensus} 

}

\caption{Plot of AUC vs number of clusters}\label{fig:plotAUC}
\end{figure}

While here we calculate the improvement in the AUC (Figure \ref{fig:plotDeltaAUC}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{delta_auc =}\StringTok{ }\KeywordTok{diff}\NormalTok{(auc_scores)}\OperatorTok{/}\NormalTok{auc_scores[}\DecValTok{1}\OperatorTok{:}\NormalTok{(}\KeywordTok{length}\NormalTok{(auc_scores)}\OperatorTok{-}\DecValTok{1}\NormalTok{)]}
\KeywordTok{plot}\NormalTok{(}\DecValTok{3}\OperatorTok{:}\DecValTok{20}\NormalTok{, delta_auc, }\DataTypeTok{col=}\StringTok{"black"}\NormalTok{, }\DataTypeTok{type=}\StringTok{"b"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

{\centering \includegraphics[width=.5\textwidth,]{images/clustering_delta_AUC_consensus} 

}

\caption{Plot of improvement in AUC vs number of clusters}\label{fig:plotDeltaAUC}
\end{figure}

The consensus clustering method suggest that the most stable is \(k=2\), which
separates over-expressed genes from under-expressed genes. While it is indeed
a very stable clustering, it does not capture the range of gene expression
patterns present in the data. This shows the limitation of such method on real
data, where the number of clusters is not clearly defined.

\hypertarget{downstream-analysis-of-clusters.}{%
\subsection{Downstream analysis of clusters.}\label{downstream-analysis-of-clusters.}}

Once good clusters are obtained, the next step is to leverage the clustering
to ease interpretation. Classic enrichment analysis can then be performed
on the gene set defined by each cluster. Examples include KEGG pathway enrichment analysis,
GO term enrichment analysis, and motif enrichment analysis.

First, let us clean up the genes we work with and only select the genes we are
going to use in the enrichment analysis. One can either all genes assigned to
the cluster, only the set of differentially expressed genes in each cluster,
or the subset of genes that fit well to a cluster (based on some criterion).

\hypertarget{finding-enriched-pathways-using-biomart-and-keggprofile}{%
\subsubsection{\texorpdfstring{Finding enriched pathways using \texttt{biomaRt} and \texttt{KEGGprofile}}{Finding enriched pathways using biomaRt and KEGGprofile}}\label{finding-enriched-pathways-using-biomart-and-keggprofile}}

Let us first tackle the case of pathway enrichment analysis. We will leverage
the packages \texttt{biomaRt} \citep{durinck:biomart} and \texttt{KEGGprofile}
\citep{zhao:keggprofile} for this step. \texttt{KEGGprofile} is a package that facilitates
enrichment analysis on a set of genes labeled with the Ensembl annotation
\citep{ensembl2020} based on the set of biological pathways described in the KEGG
database\citep{KEGG}.

We thus need to convert the gene names, which are given in the Refseq
annotation, into the corresponding Ensembl name. This is where \texttt{biomaRt} comes
in handy: it enables easy conversion from one gene annotation to another.
Here, we will use the function \texttt{getBM} in \texttt{biomaRt} to convert the gene names
from cluster 8.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{## Set up right ensembl database}
\NormalTok{ensembl =}\StringTok{ }\KeywordTok{useMart}\NormalTok{(}\StringTok{"ensembl"}\NormalTok{)}
\NormalTok{ensembl =}\StringTok{ }\KeywordTok{useDataset}\NormalTok{(}\StringTok{"mmusculus_gene_ensembl"}\NormalTok{, }\DataTypeTok{mart=}\NormalTok{ensembl)}

\CommentTok{## Get gene names of genes in Cluster 8}
\NormalTok{cluster =}\StringTok{ }\DecValTok{6}
\NormalTok{gene_names =}\StringTok{ }\KeywordTok{names}\NormalTok{(labels)}
\NormalTok{genes =}\StringTok{ }\NormalTok{gene_names[labels }\OperatorTok{==}\StringTok{ }\NormalTok{cluster]}

\CommentTok{## Convert gene names}
\NormalTok{genes =}\StringTok{ }\KeywordTok{getBM}\NormalTok{(}\DataTypeTok{attributes=}\KeywordTok{c}\NormalTok{(}\StringTok{"ensembl_gene_id"}\NormalTok{, }\StringTok{"entrezgene_id"}\NormalTok{),}
          \DataTypeTok{filters=}\StringTok{"refseq_mrna"}\NormalTok{, }\DataTypeTok{values=}\NormalTok{genes,}
          \DataTypeTok{mart=}\NormalTok{ensembl)[}\StringTok{"entrezgene_id"}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

Then we use the function \texttt{find\_enriched\_pathway} in the \texttt{KEGGprofile} package
to determine whether any KEGG pathways are enriched in cluster 6, i.e.~whether
a higher percentage of genes from a single pathway are found in cluster 6 than
we would expect by simply proportional assignment of genes to clusters.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{genes =}\StringTok{ }\KeywordTok{as.vector}\NormalTok{(}\KeywordTok{unlist}\NormalTok{(genes))}
\NormalTok{pathways =}\StringTok{ }\KeywordTok{find_enriched_pathway}\NormalTok{(}
\NormalTok{    genes, }\DataTypeTok{species=}\StringTok{"mmu"}\NormalTok{,}
    \DataTypeTok{download_latest=}\OtherTok{FALSE}\NormalTok{)}\OperatorTok{$}\NormalTok{stastic}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}cccc@{}}
\toprule
\begin{minipage}[b]{0.15\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.39\columnwidth}\centering
Pathway\strut
\end{minipage} & \begin{minipage}[b]{0.16\columnwidth}\centering
Percentage\strut
\end{minipage} & \begin{minipage}[b]{0.18\columnwidth}\centering
Adj. p-value\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.15\columnwidth}\centering
\textbf{04060}\strut
\end{minipage} & \begin{minipage}[t]{0.39\columnwidth}\centering
Cytokine-cytokine receptor
interaction\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
31\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
1.204e-20\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.15\columnwidth}\centering
\textbf{04620}\strut
\end{minipage} & \begin{minipage}[t]{0.39\columnwidth}\centering
Toll-like receptor signaling
pathway\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
39\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
4.38e-14\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.15\columnwidth}\centering
\textbf{04621}\strut
\end{minipage} & \begin{minipage}[t]{0.39\columnwidth}\centering
NOD-like receptor signaling
pathway\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
45\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
2.036e-11\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.15\columnwidth}\centering
\textbf{04623}\strut
\end{minipage} & \begin{minipage}[t]{0.39\columnwidth}\centering
Cytosolic DNA-sensing pathway\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
45\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
4.619e-11\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.15\columnwidth}\centering
\textbf{04630}\strut
\end{minipage} & \begin{minipage}[t]{0.39\columnwidth}\centering
Jak-STAT signaling pathway\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
28\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
2.516e-10\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.15\columnwidth}\centering
\textbf{04210}\strut
\end{minipage} & \begin{minipage}[t]{0.39\columnwidth}\centering
Apoptosis\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
35\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
6.279e-10\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.15\columnwidth}\centering
\textbf{04380}\strut
\end{minipage} & \begin{minipage}[t]{0.39\columnwidth}\centering
Osteoclast differentiation\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
31\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
6.279e-10\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.15\columnwidth}\centering
\textbf{04622}\strut
\end{minipage} & \begin{minipage}[t]{0.39\columnwidth}\centering
RIG-I-like receptor signaling
pathway\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
38\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
1.127e-09\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.15\columnwidth}\centering
\textbf{05160}\strut
\end{minipage} & \begin{minipage}[t]{0.39\columnwidth}\centering
Hepatitis C\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
28\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
3.436e-09\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.15\columnwidth}\centering
\textbf{04940}\strut
\end{minipage} & \begin{minipage}[t]{0.39\columnwidth}\centering
Type I diabetes mellitus\strut
\end{minipage} & \begin{minipage}[t]{0.16\columnwidth}\centering
35\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
1.158e-07\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\hypertarget{finding-enriched-go-terms}{%
\subsubsection{Finding enriched GO terms}\label{finding-enriched-go-terms}}

The Gene Ontology (GO) database \citep{GO}, also categorizes genes into meaningful
biological ontologies and can be used for enrichment analysis via the package
\texttt{topGO} \citep{alexa:topgo}. We again use \texttt{biomaRt} to find the mapping between
genes and the GO terms to which they match.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{genes =}\StringTok{ }\KeywordTok{getBM}\NormalTok{(}\DataTypeTok{attributes=}\KeywordTok{c}\NormalTok{(}\StringTok{"go_id"}\NormalTok{, }\StringTok{"refseq_mrna"}\NormalTok{),}
          \DataTypeTok{values=}\NormalTok{gene_names,}
          \DataTypeTok{filters=}\StringTok{"refseq_mrna"}\NormalTok{,}
          \DataTypeTok{mart=}\NormalTok{ensembl)}
\end{Highlighting}
\end{Shaded}

The \texttt{biomaRt} query results in a matrix with two columns: gene names and GO
term ID. The package \texttt{topGO} \citep{alexa:topgo} expects the GO term to gene
mapping to be a list where each item is a mapping between a gene name and a GO
term ID vector, for example:

\begin{verbatim}
$NM_199153
[1] "GO:0016020" "GO:0016021" "GO:0007186" "GO:0004930" "GO:0007165"
[6] "GO:0050896" "GO:0050909"

$NM_201361
 [1] "GO:0016020" "GO:0016021" "GO:0003674" "GO:0008150" "GO:0005794"
 [6] "GO:0005829" "GO:0005737" "GO:0005856" "GO:0005874" "GO:0005739"
[11] "GO:0005819" "GO:0000922" "GO:0072686"
\end{verbatim}

\texttt{moanin} provides a simple function (\texttt{create\_go\_term\_mapping}) to make this conversion:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Create gene to GO id mapping}
\NormalTok{gene_id_go_mapping =}\StringTok{ }\KeywordTok{create_go_term_mapping}\NormalTok{(genes)}
\end{Highlighting}
\end{Shaded}

Once the gene ID to GO mapping list is created, \texttt{moanin} provides an interface
to \texttt{topGO} to determine enriched GO terms. In particular, it performs a
p-value correction and only returns the significant GO-term enrichment in an
easy to use \texttt{data.frame} object. Here, we show an example of running a GO term
enrichment on the ``Biological process'' ontology (BP).

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Create logical vector of whether in cluster 6}
\NormalTok{assignments =}\StringTok{ }\NormalTok{labels }\OperatorTok{==}\StringTok{ }\NormalTok{cluster}

\NormalTok{go_terms_enriched =}\StringTok{ }\KeywordTok{find_enriched_go_terms}\NormalTok{(}
\NormalTok{    assignments,}
\NormalTok{    gene_id_go_mapping, }\DataTypeTok{ontology=}\StringTok{"BP"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}ccccc@{}}
\caption{Table continues below}\tabularnewline
\toprule
\begin{minipage}[b]{0.10\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.14\columnwidth}\centering
GO ID\strut
\end{minipage} & \begin{minipage}[b]{0.34\columnwidth}\centering
Description\strut
\end{minipage} & \begin{minipage}[b]{0.13\columnwidth}\centering
Annotated\strut
\end{minipage} & \begin{minipage}[b]{0.15\columnwidth}\centering
Significant\strut
\end{minipage}\tabularnewline
\midrule
\endfirsthead
\toprule
\begin{minipage}[b]{0.10\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.14\columnwidth}\centering
GO ID\strut
\end{minipage} & \begin{minipage}[b]{0.34\columnwidth}\centering
Description\strut
\end{minipage} & \begin{minipage}[b]{0.13\columnwidth}\centering
Annotated\strut
\end{minipage} & \begin{minipage}[b]{0.15\columnwidth}\centering
Significant\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.10\columnwidth}\centering
\textbf{6}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
\url{GO:0003002}\strut
\end{minipage} & \begin{minipage}[t]{0.34\columnwidth}\centering
regionalization\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
175\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
159\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.10\columnwidth}\centering
\textbf{7}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
\url{GO:0019395}\strut
\end{minipage} & \begin{minipage}[t]{0.34\columnwidth}\centering
fatty acid oxidation\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
58\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
56\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.10\columnwidth}\centering
\textbf{8}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
\url{GO:0007224}\strut
\end{minipage} & \begin{minipage}[t]{0.34\columnwidth}\centering
smoothened signaling pathway\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
75\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
71\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.10\columnwidth}\centering
\textbf{9}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
\url{GO:0048562}\strut
\end{minipage} & \begin{minipage}[t]{0.34\columnwidth}\centering
embryonic organ morphogenesis\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
154\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
139\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.10\columnwidth}\centering
\textbf{10}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
\url{GO:0009755}\strut
\end{minipage} & \begin{minipage}[t]{0.34\columnwidth}\centering
hormone-mediated signaling
pathway\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
76\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
71\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.10\columnwidth}\centering
\textbf{11}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
\url{GO:0006805}\strut
\end{minipage} & \begin{minipage}[t]{0.34\columnwidth}\centering
xenobiotic metabolic process\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
50\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
48\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.10\columnwidth}\centering
\textbf{12}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
\url{GO:0006790}\strut
\end{minipage} & \begin{minipage}[t]{0.34\columnwidth}\centering
sulfur compound metabolic
process\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
155\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
138\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.10\columnwidth}\centering
\textbf{13}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
\url{GO:0060173}\strut
\end{minipage} & \begin{minipage}[t]{0.34\columnwidth}\centering
limb development\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
90\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
83\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.10\columnwidth}\centering
\textbf{14}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
\url{GO:0018394}\strut
\end{minipage} & \begin{minipage}[t]{0.34\columnwidth}\centering
peptidyl-lysine acetylation\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
82\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
76\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.10\columnwidth}\centering
\textbf{15}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
\url{GO:0030166}\strut
\end{minipage} & \begin{minipage}[t]{0.34\columnwidth}\centering
proteoglycan biosynthetic
process\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
27\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
27\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.10\columnwidth}\centering
\textbf{16}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
\url{GO:0003206}\strut
\end{minipage} & \begin{minipage}[t]{0.34\columnwidth}\centering
cardiac chamber morphogenesis\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
72\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
67\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.10\columnwidth}\centering
\textbf{17}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
\url{GO:0006633}\strut
\end{minipage} & \begin{minipage}[t]{0.34\columnwidth}\centering
fatty acid biosynthetic
process\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
88\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
79\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.10\columnwidth}\centering
\textbf{18}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
\url{GO:0006261}\strut
\end{minipage} & \begin{minipage}[t]{0.34\columnwidth}\centering
DNA-dependent DNA replication\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
71\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
65\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.10\columnwidth}\centering
\textbf{19}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
\url{GO:0090596}\strut
\end{minipage} & \begin{minipage}[t]{0.34\columnwidth}\centering
sensory organ morphogenesis\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
139\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
124\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.10\columnwidth}\centering
\textbf{20}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
\url{GO:0055114}\strut
\end{minipage} & \begin{minipage}[t]{0.34\columnwidth}\centering
oxidation-reduction process\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\centering
541\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\centering
475\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\begin{longtable}[]{@{}cccc@{}}
\toprule
\begin{minipage}[b]{0.11\columnwidth}\centering
~\strut
\end{minipage} & \begin{minipage}[b]{0.14\columnwidth}\centering
Expected\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\centering
P-value\strut
\end{minipage} & \begin{minipage}[b]{0.18\columnwidth}\centering
Adj. p-value\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{6}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
142.5\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.00044\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
0.3749\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{7}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
47.22\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.00065\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
0.4747\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{8}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
61.07\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.00083\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
0.5304\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{9}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
125.4\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.00175\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
0.994\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{10}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
61.88\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.00254\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
1\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{11}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
40.71\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.00257\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
1\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{12}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
126.2\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.00317\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
1\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{13}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
73.28\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.00325\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
1\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{14}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
66.77\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.00336\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
1\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{15}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
21.98\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.00386\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
1\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{16}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
58.62\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.00449\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
1\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{17}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
71.65\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.00580\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
1\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{18}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
57.81\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.00595\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
1\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{19}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
113.2\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.00637\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
1\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.11\columnwidth}\centering
\textbf{20}\strut
\end{minipage} & \begin{minipage}[t]{0.14\columnwidth}\centering
440.5\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\centering
0.00651\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\centering
1\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\hypertarget{conclusion}{%
\section{Conclusion}\label{conclusion}}

This workflow provides a tutoral for the analysis of lengthy time-course gene
expression data in R using the package \texttt{moanin}, which aids in implementing
common timecourse analyses. We illustrate the workflow through the analysis of
mice lung tissue exposed to different influenza strain and measured over time.
The proposed workflow covers consists of three common analysis main steps
generally performed after quality control and normalization: (1) differential
expression analysis; (2) clustering of time-course gene expression data; (3)
downstream analysis of clusters. We demonstrate how the use of the package
\texttt{moanin} allows for easy implementation of these procedures in the setting of
time-course data.

\hypertarget{software-and-data-availability}{%
\section{Software and data availability}\label{software-and-data-availability}}

The source code for this workflow can be found at
\url{https://github.com/NelleV/2019timecourse-rnaseq-pipeline}.
Archived source code at the time of publication can be found at \url{XXX}.

All packages use in the workflow are available on GitHub, CRAN, or
Bioconductor.

Data used in this workflow are available from NCBI GEO, accession
\href{https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE63786}{GSE63786}.
Normalized data can be found in \texttt{timecoursedata}. Normalization information is
provided as supplementary information.

Last but not least, we use \texttt{sessionInfo()} to display all packages used in
this pipeline and their version numbers.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.0.2 (2020-06-22)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04 LTS
## 
## Matrix products: default
## BLAS:   /usr/local/lib/R/lib/libRblas.so
## LAPACK: /usr/local/lib/R/lib/libRlapack.so
## 
## locale:
## [1] C
## 
## attached base packages:
##  [1] stats4    parallel  splines   stats     graphics  grDevices utils    
##  [8] datasets  methods   base     
## 
## other attached packages:
##  [1] RColorBrewer_1.1-2          BiocWorkflowTools_1.14.0   
##  [3] ggfortify_0.4.10            timecoursedata_0.99.17     
##  [5] moanin_0.99.0-902           SummarizedExperiment_1.18.2
##  [7] DelayedArray_0.14.1         matrixStats_0.56.0         
##  [9] GenomicRanges_1.40.0        GenomeInfoDb_1.24.2        
## [11] topGO_2.40.0                SparseM_1.78               
## [13] GO.db_3.11.4                AnnotationDbi_1.50.1       
## [15] IRanges_2.22.2              S4Vectors_0.26.1           
## [17] graph_1.66.0                viridis_0.5.1              
## [19] viridisLite_0.3.0           KEGGprofile_1.30.0         
## [21] NMF_0.22.0                  Biobase_2.48.0             
## [23] BiocGenerics_0.34.0         cluster_2.1.0              
## [25] rngtools_1.5                pkgmaker_0.31.1            
## [27] registry_0.5-1              ggplot2_3.3.2              
## [29] pander_0.6.3                biomaRt_2.44.1             
## [31] BiocStyle_2.16.0            knitr_1.29                 
## [33] limma_3.44.3                devtools_2.3.0             
## [35] usethis_1.6.1               rmarkdown_2.3              
## 
## loaded via a namespace (and not attached):
##  [1] colorspace_1.4-1       ellipsis_0.3.1         rprojroot_1.3-2       
##  [4] XVector_0.28.0         fs_1.4.2               rstudioapi_0.11       
##  [7] remotes_2.1.1          bit64_0.9-7.1          fansi_0.4.1           
## [10] ClusterR_1.2.2         KEGG.db_3.2.4          codetools_0.2-16      
## [13] doParallel_1.0.15      pkgload_1.1.0          gridBase_0.4-7        
## [16] dbplyr_1.4.4           png_0.1-7              BiocManager_1.30.10   
## [19] compiler_4.0.2         httr_1.4.1             backports_1.1.8       
## [22] Matrix_1.2-18          assertthat_0.2.1       cli_2.0.2             
## [25] htmltools_0.5.0        prettyunits_1.1.1      tools_4.0.2           
## [28] gmp_0.6-0              gtable_0.3.0           glue_1.4.1            
## [31] GenomeInfoDbData_1.2.3 reshape2_1.4.4         dplyr_1.0.0           
## [34] rappdirs_0.3.1         Rcpp_1.0.5             vctrs_0.3.1           
## [37] Biostrings_2.56.0      NMI_2.0                iterators_1.0.12      
## [40] xfun_0.15              stringr_1.4.0          ps_1.3.3              
## [43] testthat_2.3.2         lifecycle_0.2.0        gtools_3.8.2          
## [46] XML_3.99-0.4           edgeR_3.30.3           MASS_7.3-51.6         
## [49] zlibbioc_1.34.0        scales_1.1.1           hms_0.5.3             
## [52] yaml_2.2.1             curl_4.3               memoise_1.1.0         
## [55] gridExtra_2.3          TeachingDemos_2.12     stringi_1.4.6         
## [58] RSQLite_2.2.0          desc_1.2.0             foreach_1.5.0         
## [61] pkgbuild_1.1.0         bibtex_0.4.2.2         rlang_0.4.7           
## [64] pkgconfig_2.0.3        bitops_1.0-6           evaluate_0.14         
## [67] lattice_0.20-41        purrr_0.3.4            bit_1.1-15.2          
## [70] processx_3.4.3         tidyselect_1.1.0       plyr_1.8.6            
## [73] magrittr_1.5           bookdown_0.20          R6_2.4.1              
## [76] generics_0.0.2         DBI_1.1.0              pillar_1.4.6          
## [79] withr_2.2.0            KEGGREST_1.28.0        RCurl_1.98-1.2        
## [82] tibble_3.0.3           crayon_1.3.4           BiocFileCache_1.12.0  
## [85] progress_1.2.2         locfit_1.5-9.4         grid_4.0.2            
## [88] blob_1.2.1             callr_3.4.3            git2r_0.27.1          
## [91] digest_0.6.25          xtable_1.8-4           tidyr_1.1.0           
## [94] openssl_1.4.2          munsell_0.5.0          sessioninfo_1.1.1     
## [97] askpass_1.1
\end{verbatim}

\hypertarget{author-contributions}{%
\section{Author contributions}\label{author-contributions}}

NV and EP wrote the workflow.

\hypertarget{competing-interests}{%
\section{Competing interests}\label{competing-interests}}

The authors declare that they have no competing interests.

\hypertarget{grant-information}{%
\section{Grant information}\label{grant-information}}

This research was funded in part by a Department of Energy (DOE) grant
(DE-SC0014081); by the Gordon and Betty Moore Foundation (Grant GBMF3834) and
the Alfred P. Sloan Foundation (Grant 2013-10-27) to the University of
California, Berkeley {[}N.V.{]}; by a ENS-CFM Data Science Chair {[}E.P.{]}.

\emph{I confirm that the funders had no role in study design, data collection and
analysis, decision to publish, or preparation of the manuscript.}

\hypertarget{acknowledgments}{%
\section{Acknowledgments}\label{acknowledgments}}

The authors thank Karthik Ram and the Ropensci community for valuable
feedback.

\renewcommand\refname{References}
{\small\bibliography{bibliography.bib}}

\end{document}
